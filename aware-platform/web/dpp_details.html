<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Product Passport - Aware‚Ñ¢</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="aware-style.css">
    <script src="batches.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
</head>
<body>
    <div class="app">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <img src="aware-logo.png" alt="AWARE" style="width: 28px; height: 28px; display: inline-block; vertical-align: middle; margin-right: 8px;">
                AWARE‚Ñ¢
            </div>
            <div class="nav" id="sidebar-nav">
                <a href="index.html">Home</a>
                <a href="dpp.html" class="active">Digital Product Passport</a>
            </div>
            <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid rgba(245,245,245,.1);">
                <div style="color: rgba(245,245,245,.6); font-size: 12px; margin-bottom: 8px;">
                    Logged in as: <strong id="username-display">-</strong>
                </div>
                <div style="color: rgba(245,245,245,.6); font-size: 12px; margin-bottom: 12px;">
                    Role: <strong id="role-display">-</strong>
                </div>
                <button onclick="logout()" class="btn-secondary" style="width: 100%; font-size: 13px; background: #FF3300; color: white; border-radius: 20px; border: none;">Logout</button>
            </div>
        </aside>

        <main class="main">
            <!-- Top Header -->
            <header class="topbar">
                <div class="topbar-inner">
                    <div class="page-head">
                        <div>
                            <h1>Digital Product Passport</h1>
                            <p>Complete traceability information for this product</p>
                        </div>
                        <div>
                            <button onclick="window.location.href='dpp.html'" style="padding: 10px 20px; background: #FF3300; color: white; border: none; border-radius: 20px; font-weight: 600; cursor: pointer;">‚Üê Back to List</button>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Main Content -->
            <section class="content">
                <div class="shell">
                    <div id="dpp-content">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        let currentUser = null;
        let currentBatch = null;

        window.addEventListener('load', async function() {
            try {
                const response = await fetch('/api/auth/session', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    window.location.href = 'login.html';
                    return;
                }

                const data = await response.json();
                
                if (!data.loggedIn) {
                    window.location.href = 'login.html';
                    return;
                }

                currentUser = data.user;
                document.getElementById('username-display').textContent = currentUser.username;
                document.getElementById('role-display').textContent = ROLE_LABELS[currentUser.role] || 'Unknown';

                // Only allow Brand (Distributor=2) and Admin (4) roles
                if (currentUser.role !== 2 && currentUser.role !== 4) {
                    alert('Access denied. This page is only for brand users.');
                    window.location.href = 'index.html';
                    return;
                }

                loadBatchDPP();
            } catch (error) {
                console.error('Auth check error:', error);
                window.location.href = 'login.html';
            }
        });

        async function loadBatchDPP() {
            const urlParams = new URLSearchParams(window.location.search);
            const batchId = urlParams.get('id');

            if (!batchId) {
                window.location.href = 'dpp.html';
                return;
            }

            try {
                const response = await fetch('/batch/' + batchId, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('HTTP error! status: ' + response.status);
                }
                
                currentBatch = await response.json();
                displayDPP(currentBatch);
            } catch (error) {
                console.error('Error loading batch:', error);
                document.getElementById('dpp-content').innerHTML = `
                    <div class="card--page" style="padding: 40px; text-align: center;">
                        <h2>Error Loading Product Passport</h2>
                        <p>Could not load the digital product passport for this batch.</p>
                        <button onclick="window.location.href='dpp.html'" class="btn-primary">Back to List</button>
                    </div>
                `;
            }
        }

        function displayDPP(batch) {
            const showField = (label, value) => {
                if (value && value !== 'N/A' && value.trim() !== '') {
                    return `<div style="margin-bottom: 8px;"><strong>${label}:</strong> ${value}</div>`;
                }
                return '';
            };

            // Parse composition to extract percentages
            const parseComposition = (compositionStr) => {
                if (!compositionStr) return [];
                const materials = [];
                const regex = /(\d+)%?\s*([^,\(]+)(?:\s*\(([^)]+)\))?/g;
                let match;
                while ((match = regex.exec(compositionStr)) !== null) {
                    materials.push({
                        percentage: match[1],
                        name: match[2].trim(),
                        type: match[3] || ''
                    });
                }
                return materials;
            };

            const compositions = parseComposition(batch.physicalAsset.composition);
            const sustainableScore = compositions.length > 0 ? 100 : 0;

            const content = `
                <div style="display: grid; grid-template-columns: 280px 1fr; gap: 30px;">
                    <!-- Left Column - QR Code -->
                    <div>
                        <div class="card" style="padding: 20px; margin-bottom: 20px;">
                            <h3 style="font-size: 14px; font-weight: 700; margin-bottom: 16px;">QR Code</h3>
                            <canvas id="qrcode" style="width: 100%; height: auto;"></canvas>
                            <div style="margin-top: 12px; font-size: 11px; color: var(--muted); word-break: break-all;">
                                ${window.location.href}
                            </div>
                        </div>

                        <!-- PO Details -->
                        <div class="card" style="padding: 20px;">
                            <h3 style="font-size: 14px; font-weight: 700; margin-bottom: 16px;">Batch Details</h3>
                            <div style="font-size: 12px;">
                                <div style="color: var(--muted); margin-bottom: 4px;">Batch number</div>
                                <div style="font-weight: 600; margin-bottom: 12px;">${batch.physicalAsset.batchNumber || 'N/A'}</div>
                                
                                <div style="color: var(--muted); margin-bottom: 4px;">Asset ID</div>
                                <div style="font-weight: 600; margin-bottom: 12px; word-break: break-all;">${batch.physicalAsset.assetId || 'N/A'}</div>
                                
                                <div style="color: var(--muted); margin-bottom: 4px;">Production Date</div>
                                <div style="font-weight: 600; margin-bottom: 12px;">${batch.physicalAsset.productionDate || 'N/A'}</div>
                                
                                <div style="color: var(--muted); margin-bottom: 4px;">Material Description</div>
                                <div style="font-weight: 600; margin-bottom: 12px;">${batch.physicalAsset.material || 'N/A'}</div>
                                
                                <div style="color: var(--muted); margin-bottom: 4px;">Producer</div>
                                <div style="font-weight: 600;">${batch.physicalAsset.productionFacility || batch.createdByName || 'N/A'}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column - Main Content -->
                    <div class="card--page">
                        <!-- Virtual ID Header -->
                        <div style="background: var(--primary); color: white; padding: 12px 20px; margin: -26px -26px 20px -26px; border-radius: var(--r-lg) var(--r-lg) 0 0;">
                            <div style="font-size: 11px; letter-spacing: 2px; opacity: 0.8; margin-bottom: 4px;">VIRTUAL ID</div>
                            <div style="font-size: 16px; font-weight: 600;">${batch.physicalAsset.assetId || 'Batch #' + batch.id}</div>
                        </div>

                        <!-- Product Title -->
                        <div style="margin-bottom: 24px;">
                            <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 8px; color: var(--primary);">
                                ${batch.physicalAsset.material || 'Product'} - ${batch.physicalAsset.mainColor || 'Natural'}
                            </h2>
                            <p style="color: var(--muted); font-size: 14px;">${batch.physicalAsset.composition || ''}</p>
                        </div>

                    <!-- Validated Badge -->
                    ${batch.physicalAsset.assetId ? `
                    <div style="margin-bottom: 24px;">
                        <div style="display: inline-block; background: #4CAF50; color: white; padding: 10px 20px; border-radius: 25px; font-weight: 700; font-size: 13px;">
                            <img src="aware-logo.png" alt="AWARE" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px; filter: brightness(0) invert(1);">
                            VALIDATED BY AWARE‚Ñ¢
                        </div>
                    </div>
                    ` : ''}

                    <!-- Product Image Placeholder -->
                    <div style="background: #f5f5f5; border-radius: var(--r-lg); height: 300px; margin-bottom: 24px; display: flex; align-items: center; justify-content: center; border: 1px solid var(--border);">
                        <div style="text-align: center; color: var(--muted);">
                            <div style="font-size: 48px; margin-bottom: 12px;">üì¶</div>
                            <div>${batch.physicalAsset.material || 'Product'}</div>
                        </div>
                    </div>

                    <!-- Sustainable Material Score -->
                    <div style="background: #003087; color: white; padding: 24px; border-radius: var(--r-lg); margin-bottom: 24px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <div style="font-size: 16px;">Aware‚Ñ¢ sustainable material score</div>
                            <div style="font-size: 36px; font-weight: 700; display: flex; align-items: center;">
                                <span style="width: 12px; height: 12px; background: #4CAF50; border-radius: 50%; display: inline-block; margin-right: 12px;"></span>
                                ${sustainableScore}%
                            </div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); height: 4px; border-radius: 2px; overflow: hidden;">
                            <div style="background: white; height: 100%; width: ${sustainableScore}%;"></div>
                        </div>
                    </div>

                    <!-- Composition Details -->
                    ${compositions.length > 0 ? `
                    <div style="margin-bottom: 24px;">
                        <div style="font-size: 14px; color: var(--muted); margin-bottom: 16px;">
                            All the data of this product comes directly from the Aware‚Ñ¢ blockchain platform and is added by the makers.
                        </div>
                        ${compositions.map(comp => `
                            <div style="margin-bottom: 20px;">
                                <div style="font-size: 32px; font-weight: 700; color: var(--primary);">${comp.percentage}%</div>
                                <div style="font-size: 14px; color: var(--muted);">${comp.name}${comp.type ? ' (' + comp.type + ')' : ''}</div>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}

                    <!-- Working Conditions -->
                    ${batch.compliance.sustainabilityCert || batch.compliance.fairTradeCert ? `
                    <div style="background: #f5f5f5; padding: 20px; border-radius: var(--r-lg); margin-bottom: 24px;">
                        <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 16px;">Working Conditions</h3>
                        <div style="display: flex; align-items: start; gap: 12px;">
                            <div style="color: #4CAF50; font-size: 24px;">‚úì</div>
                            <div style="font-size: 14px; color: var(--text);">
                                Social compliances are validated at every step in the supply chain.
                            </div>
                        </div>
                    </div>
                    ` : ''}

                    <!-- Detailed Information Grid -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 32px;">
                        <!-- Product Information -->
                        <div class="card" style="padding: 20px;">
                            <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 16px; color: var(--scarlet);">üì¶ Product Information</h3>
                            <div style="font-size: 13px;">
                                ${showField('Production Date', batch.physicalAsset.productionDate)}
                                ${showField('Aware‚Ñ¢ Asset ID', batch.physicalAsset.assetId)}
                                ${showField('Material Type', batch.physicalAsset.material)}
                                ${showField('Total Weight (Kgs)', batch.physicalAsset.weight)}
                                ${showField('Batch Number', batch.physicalAsset.batchNumber)}
                                ${showField('Production Facility', batch.physicalAsset.productionFacility)}
                            </div>
                        </div>

                        <!-- Supply Chain -->
                        <div class="card" style="padding: 20px;">
                            <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 16px; color: var(--scarlet);">üîó Supply Chain</h3>
                            <div style="font-size: 13px;">
                                ${showField('Value Chain (Main)', batch.physicalAsset.valueChainMain)}
                                ${showField('Value Chain (Sub)', batch.physicalAsset.valueChainSub)}
                                ${showField('Supplier', batch.tracer.supplier)}
                                ${showField('Country', batch.tracer.country)}
                            </div>
                        </div>

                        <!-- Traceability -->
                        <div class="card" style="padding: 20px;">
                            <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 16px; color: var(--scarlet);">üåç Traceability</h3>
                            <div style="font-size: 13px;">
                                ${showField('Aware‚Ñ¢ Asset ID', batch.physicalAsset.assetId)}
                                ${batch.physicalAsset.assetId ? showField('Tracer Type', 'Aware') : ''}
                                ${showField('Harvest Date', batch.tracer.harvestDate)}
                                ${showField('Tracer Added', batch.tracer.tracerAdded === 'true' ? 'Yes' : 'No')}
                            </div>
                        </div>

                        <!-- Sustainability -->
                        <div class="card" style="padding: 20px;">
                            <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 16px; color: var(--scarlet);">üåø Sustainability</h3>
                            <div style="font-size: 13px;">
                                ${showField('Sustainable Claims', batch.physicalAsset.sustainableClaims)}
                                <div style="margin-bottom: 8px;"><strong>Environmental:</strong> ${batch.compliance.sustainabilityCert || 'None'}</div>
                                <div style="margin-bottom: 8px;"><strong>Social:</strong> ${batch.compliance.fairTradeCert || 'None'}</div>
                            </div>
                        </div>

                        <!-- Validation -->
                        <div class="card" style="padding: 20px;">
                            <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 16px; color: var(--scarlet);">‚úì Validation</h3>
                            <div style="font-size: 13px;">
                                ${showField('Validation Type', batch.validation.inspector || 'Self-Validation')}
                                ${showField('Status', 'Success')}
                                ${showField('Inspection Date', batch.validation.inspectionDate)}
                            </div>
                        </div>

                        <!-- Blockchain Info -->
                        <div class="card" style="padding: 20px;">
                            <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 16px; color: var(--scarlet);">üîê Blockchain Information</h3>
                            <div style="font-size: 13px;">
                                <div style="margin-bottom: 8px;"><strong>Batch ID:</strong> #${batch.id}</div>
                                <div style="margin-bottom: 8px;"><strong>Status:</strong> ${getStatusBadge(batch.status)}</div>
                                <div style="margin-bottom: 8px;"><strong>Created:</strong> ${formatDateTime(batch.createdAt)}</div>
                                ${batch.approvedAt > 0 ? '<div style="margin-bottom: 8px;"><strong>Approved:</strong> ' + formatDateTime(batch.approvedAt) + '</div>' : ''}
                            </div>
                        </div>
                    </div>
                </div>
                </div>
            `;

            document.getElementById('dpp-content').innerHTML = content;
            
            // Generate QR Code
            setTimeout(() => {
                const canvas = document.getElementById('qrcode');
                if (canvas) {
                    QRCode.toCanvas(canvas, window.location.href, {
                        width: 240,
                        margin: 1,
                        color: {
                            dark: '#000000',
                            light: '#FFFFFF'
                        }
                    }, function (error) {
                        if (error) console.error('QR Code error:', error);
                    });
                }
            }, 100);
        }

        function getStatusBadge(status) {
            const statusLabels = {
                0: 'Pending',
                1: 'Approved',
                2: 'Rejected',
                3: 'Certified'
            };
            const statusClasses = {
                0: 'status-pending',
                1: 'status-approved',
                2: 'status-rejected',
                3: 'status-certified'
            };
            const label = statusLabels[status] || 'Unknown';
            const className = statusClasses[status] || '';
            return '<span class="status-badge ' + className + '">' + label + '</span>';
        }

        async function logout() {
            try {
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Logout error:', error);
            }
        }
    </script>
</body>
</html>
