<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aware‚Ñ¢ Blockchain Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="aware-style.css">
    <script src="aware-sdk.js"></script>
</head>

<body>
    <div class="app">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <img src="aware-logo.png" alt="AWARE" style="width: 28px; height: 28px; display: inline-block; vertical-align: middle; margin-right: 8px;">
                AWARE‚Ñ¢
            </div>
            <div class="nav">
                <a href="index.html">Home</a>
                <a href="wallet.html">Wallet</a>
                <a href="create_token.html">Create Token</a>
                <a href="update_token.html">Update Token</a>
                <a href="blockchain.html" class="active">Blockchain Dashboard</a>
                <a href="batches.html">View Batches</a>
                <a href="batch_approve.html">Approve Batches</a>
            </div>
        </aside>

        <main class="main">
            <!-- Top Header -->
            <header class="topbar">
                <div class="topbar-inner">
                    <div class="page-head">
                        <div>
                            <h1>Blockchain Dashboard</h1>
                            <p>Connect your wallet and manage blockchain operations</p>
                        </div>
                    </div>
                </div>
            </header>

            <section class="content">
                <div class="shell">
                    <!-- Connection Status -->
                    <div class="card--page" style="margin-bottom: 20px;">
                        <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 12px;">üîó Connection Status</h3>
                        <div id="connectionStatus">
                            <div class="info-box" style="background: #f5f5f5; border-left: 4px solid #999;">
                                <strong>Status:</strong> <span id="statusText">Not connected</span>
                            </div>
                        </div>
                        <div style="margin-top: 15px;">
                            <button id="connectBtn" class="btn-primary" onclick="connectWallet()">Connect Wallet</button>
                            <button id="disconnectBtn" class="btn-secondary" style="display: none;" onclick="disconnectWallet()">Disconnect</button>
                        </div>
                    </div>

                    <!-- Blockchain Info -->
                    <div class="card--page" style="margin-bottom: 20px;">
                        <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 12px;">‚õìÔ∏è Blockchain Information</h3>
                        <div id="blockchainInfo" style="display: none;">
                            <div class="grid-2">
                                <div class="form-group">
                                    <label>Network:</label>
                                    <input type="text" id="networkName" readonly>
                                </div>
                                <div class="form-group">
                                    <label>Chain ID:</label>
                                    <input type="text" id="chainId" readonly>
                                </div>
                                <div class="form-group">
                                    <label>Contract Address:</label>
                                    <input type="text" id="contractAddress" readonly>
                                </div>
                                <div class="form-group">
                                    <label>Your Address:</label>
                                    <input type="text" id="userAddress" readonly>
                                </div>
                            </div>
                        </div>
                        <div id="noBlockchain" class="info-box" style="background: #fff3e0; border-left: 4px solid #FF3300;">
                            Loading blockchain information...
                        </div>
                    </div>

                    <!-- User Registration -->
                    <div class="card--page" id="registrationCard" style="display: none;">
                        <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 12px;">üë§ User Registration</h3>
                        <div id="userStatus"></div>
                        <div id="registrationForm" style="display: none; margin-top: 15px;">
                            <div class="form-group">
                                <label>Your Name:</label>
                                <input type="text" id="userName" placeholder="Enter your full name">
                            </div>
                            <div class="form-group">
                                <label>Role:</label>
                                <select id="userRole">
                                    <option value="">Select role...</option>
                                    <option value="Producer">Producer</option>
                                    <option value="Manufacturer">Manufacturer</option>
                                    <option value="Distributor">Distributor</option>
                                    <option value="Certifier">Certifier</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <button class="btn-primary" onclick="registerUser()">Register on Blockchain</button>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        let provider = null;
        let signer = null;
        let userAddress = null;
        let blockchainInfo = null;

        async function loadBlockchainInfo() {
            try {
                const response = await fetch('/api/blockchain/info');
                const data = await response.json();
                
                if (data.isReady) {
                    blockchainInfo = data;
                    document.getElementById('blockchainInfo').style.display = 'block';
                    document.getElementById('noBlockchain').style.display = 'none';
                    document.getElementById('networkName').value = data.network;
                    document.getElementById('chainId').value = data.chainId;
                    document.getElementById('contractAddress').value = data.contractAddress;
                } else {
                    document.getElementById('noBlockchain').innerHTML = `
                        <strong>‚ö†Ô∏è Blockchain Not Ready</strong><br>
                        ${data.message}<br><br>
                        <strong>Instructions:</strong><br>
                        1. Open terminal and run: <code>npm run blockchain:node</code><br>
                        2. In another terminal run: <code>npm run blockchain:deploy</code><br>
                        3. Restart the server to detect the deployed contract
                    `;
                }
            } catch (error) {
                console.error('Error loading blockchain info:', error);
                document.getElementById('noBlockchain').innerHTML = `
                    <strong>‚ùå Error:</strong> Could not connect to blockchain API
                `;
            }
        }

        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                alert('MetaMask is not installed! Please install MetaMask to use blockchain features.');
                return;
            }

            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAddress = accounts[0];
                
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();

                document.getElementById('userAddress').value = userAddress;
                document.getElementById('statusText').textContent = 'Connected';
                document.getElementById('connectionStatus').innerHTML = `
                    <div class="info-box" style="background: #e8f5e9; border-left: 4px solid #4caf50;">
                        <strong>Status:</strong> Connected<br>
                        <strong>Address:</strong> ${userAddress}
                    </div>
                `;
                
                document.getElementById('connectBtn').style.display = 'none';
                document.getElementById('disconnectBtn').style.display = 'inline-block';
                document.getElementById('registrationCard').style.display = 'block';

                // Check if user is registered
                await checkUserRegistration();
            } catch (error) {
                console.error('Error connecting wallet:', error);
                alert('Error connecting to MetaMask: ' + error.message);
            }
        }

        function disconnectWallet() {
            provider = null;
            signer = null;
            userAddress = null;

            document.getElementById('statusText').textContent = 'Not connected';
            document.getElementById('connectionStatus').innerHTML = `
                <div class="info-box" style="background: #f5f5f5; border-left: 4px solid #999;">
                    <strong>Status:</strong> Not connected
                </div>
            `;
            
            document.getElementById('connectBtn').style.display = 'inline-block';
            document.getElementById('disconnectBtn').style.display = 'none';
            document.getElementById('registrationCard').style.display = 'none';
            document.getElementById('userAddress').value = '';
        }

        async function checkUserRegistration() {
            if (!userAddress) return;

            try {
                const response = await fetch(`/api/blockchain/info`);
                const data = await response.json();
                
                // This is a simplified check - you might want to add an endpoint to check user registration
                document.getElementById('userStatus').innerHTML = `
                    <div class="info-box" style="background: #fff3e0; border-left: 4px solid #FF3300;">
                        <strong>Info:</strong> To register on the blockchain, fill in the form below
                    </div>
                `;
                document.getElementById('registrationForm').style.display = 'block';
            } catch (error) {
                console.error('Error checking registration:', error);
            }
        }

        async function registerUser() {
            const name = document.getElementById('userName').value.trim();
            const role = document.getElementById('userRole').value;

            if (!name || !role) {
                alert('Please fill in all fields');
                return;
            }

            if (!userAddress) {
                alert('Please connect your wallet first');
                return;
            }

            try {
                const response = await fetch('/api/blockchain/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, role, address: userAddress })
                });

                const result = await response.json();

                if (result.success) {
                    alert('Successfully registered on blockchain!\nTransaction: ' + result.transactionHash);
                    document.getElementById('registrationForm').style.display = 'none';
                    document.getElementById('userStatus').innerHTML = `
                        <div class="info-box" style="background: #e8f5e9; border-left: 4px solid #4caf50;">
                            <strong>‚úì Registered</strong><br>
                            Name: ${name}<br>
                            Role: ${role}<br>
                            Transaction: ${result.transactionHash}
                        </div>
                    `;
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Registration error:', error);
                alert('Error registering user: ' + error.message);
            }
        }

        // Load blockchain info on page load
        window.addEventListener('load', () => {
            loadBlockchainInfo();
        });
    </script>

    <!-- Include ethers.js for blockchain interactions -->
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
</body>

</html>
