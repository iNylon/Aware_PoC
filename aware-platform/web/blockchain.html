<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aware‚Ñ¢ Blockchain Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="aware-style.css">
    <script src="aware-sdk.js"></script>
</head>

<body>
    <div class="app">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <img src="aware-logo.png" alt="AWARE" style="width: 28px; height: 28px; display: inline-block; vertical-align: middle; margin-right: 8px;">
                AWARE‚Ñ¢
            </div>
            <div class="nav">
                <a href="index.html">Home</a>
                <a href="create_token.html">Create Token</a>
                <a href="update_token.html">Update Token</a>
            </div>
            <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid rgba(245,245,245,.1);">
                <div style="color: rgba(245,245,245,.6); font-size: 12px; margin-bottom: 8px;">
                    Logged in as: <strong id="username-display">-</strong>
                </div>
                <div style="color: rgba(245,245,245,.6); font-size: 12px; margin-bottom: 12px;">
                    Role: <strong id="role-display">-</strong>
                </div>
                <button onclick="logout()" class="btn-secondary" style="width: 100%; font-size: 13px; background: #FF3300; color: white; border-radius: 20px; border: none;">Logout</button>
            </div>
        </aside>

        <main class="main">
            <!-- Top Header -->
            <header class="topbar">
                <div class="topbar-inner">
                    <div class="page-head">
                        <div>
                            <h1>Blockchain Dashboard</h1>
                            <p>Connect your wallet and manage blockchain operations</p>
                        </div>
                    </div>
                </div>
            </header>

            <section class="content">
                <div class="shell">
                    <!-- Connection Status -->
                    <div class="card--page" style="margin-bottom: 20px;">
                        <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 12px;">üîó Connection Status</h3>
                        <div id="connectionStatus">
                            <div class="info-box" style="background: #f5f5f5; border-left: 4px solid #999;">
                                <strong>Status:</strong> <span id="statusText">Not connected</span>
                            </div>
                        </div>
                        <div style="margin-top: 15px;">
                            <button id="connectBtn" class="btn-primary" onclick="connectWallet()">Connect Wallet</button>
                            <button id="disconnectBtn" class="btn-secondary" style="display: none;" onclick="disconnectWallet()">Disconnect</button>
                        </div>
                    </div>

                    <!-- Blockchain Info -->
                    <div class="card--page" style="margin-bottom: 20px;">
                        <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 12px;">‚õìÔ∏è Blockchain Information</h3>
                        <div id="blockchainInfo" style="display: none;">
                            <div class="grid-2">
                                <div class="form-group">
                                    <label>Network:</label>
                                    <input type="text" id="networkName" readonly>
                                </div>
                                <div class="form-group">
                                    <label>Chain ID:</label>
                                    <input type="text" id="chainId" readonly>
                                </div>
                                <div class="form-group">
                                    <label>Contract Address:</label>
                                    <input type="text" id="contractAddress" readonly>
                                </div>
                                <div class="form-group">
                                    <label>Your Address:</label>
                                    <input type="text" id="userAddress" readonly>
                                </div>
                            </div>
                        </div>
                        <div id="noBlockchain" class="info-box" style="background: #fff3e0; border-left: 4px solid #FF3300;">
                            Loading blockchain information...
                        </div>
                    </div>

                    <!-- User Registration -->
                    <div class="card--page" id="registrationCard" style="display: none;">
                        <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 12px;">üë§ User Registration</h3>
                        <div id="userStatus"></div>
                        <div id="registrationForm" style="display: none; margin-top: 15px;">
                            <div class="form-group">
                                <label>Your Name:</label>
                                <input type="text" id="userName" placeholder="Enter your full name">
                            </div>
                            <div class="form-group">
                                <label>Role:</label>
                                <select id="userRole">
                                    <option value="">Select role...</option>
                                    <option value="Producer">Producer</option>
                                    <option value="Manufacturer">Manufacturer</option>
                                    <option value="Distributor">Distributor</option>
                                    <option value="Certifier">Certifier</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <button class="btn-primary" onclick="registerUser()">Register on Blockchain</button>
                        </div>
                    </div>

                    <!-- Batches Section -->
                    <div class="card--page" style="margin-top: 20px;">
                        <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 12px;">üì¶ All Blockchain Batches</h3>
                        
                        <div class="filter-bar">
                            <input type="text" id="searchBatch" placeholder="üîç Search by Asset ID..." oninput="filterBlockchainBatches()">
                            <select id="statusFilter" onchange="filterBlockchainBatches()">
                                <option value="">All Statuses</option>
                                <option value="0">Pending</option>
                                <option value="1">Approved</option>
                                <option value="2">Rejected</option>
                                <option value="3">Certified</option>
                            </select>
                            <button class="btn-primary" onclick="loadBlockchainBatches()">üîÑ Refresh</button>
                        </div>

                        <div id="blockchain-loading-message" style="text-align: center; padding: 40px; color: var(--muted);">
                            Loading batches from blockchain...
                        </div>

                        <div id="blockchain-batches-container" style="display: none;">
                            <div style="overflow-x: auto; margin-top: 15px;">
                                <table class="batch-table" id="blockchainBatchTable">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Type</th>
                                            <th>Color</th>
                                            <th>Asset ID</th>
                                            <th>Weight Kgs</th>
                                            <th>Status</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="blockchainBatchTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div id="blockchain-no-batches" style="display: none; text-align: center; padding: 40px;">
                            <div style="font-size: 48px; margin-bottom: 16px;">üì¶</div>
                            <h3 style="margin-bottom: 8px;">No batches found</h3>
                            <p style="color: var(--muted);">No batches available on the blockchain yet.</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Batch Details Modal -->
    <div id="batchModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;" onclick="closeBatchModal(event)">
        <div style="max-width: 900px; margin: 40px auto; background: white; border-radius: var(--r-lg); padding: 30px; position: relative;" onclick="event.stopPropagation()">
            <button onclick="closeBatchModal()" style="position: absolute; top: 20px; right: 20px; background: none; border: none; font-size: 24px; cursor: pointer; color: var(--muted);">&times;</button>
            <div id="batchModalContent"></div>
        </div>
    </div>

    <script src="batches.js"></script>
    <script>
        let currentUser = null;
        let provider = null;
        let signer = null;
        let userAddress = null;
        let blockchainInfo = null;
        let allBlockchainBatches = [];
        let filteredBlockchainBatches = [];

        // Load batches from blockchain
        async function loadBlockchainBatches() {
            try {
                document.getElementById('blockchain-loading-message').style.display = 'block';
                document.getElementById('blockchain-batches-container').style.display = 'none';
                document.getElementById('blockchain-no-batches').style.display = 'none';

                allBlockchainBatches = await loadBatchesGlobally();
                filteredBlockchainBatches = [...allBlockchainBatches];

                document.getElementById('blockchain-loading-message').style.display = 'none';

                if (allBlockchainBatches.length === 0) {
                    document.getElementById('blockchain-no-batches').style.display = 'block';
                } else {
                    document.getElementById('blockchain-batches-container').style.display = 'block';
                    renderBatchTable(filteredBlockchainBatches, 'blockchainBatchTableBody', 'viewBlockchainBatchDetails');
                }
            } catch (error) {
                console.error('Error loading blockchain batches:', error);
                document.getElementById('blockchain-loading-message').innerHTML = `
                    <div style="color: #f44336;">
                        Error loading batches. Please make sure the blockchain is running.
                    </div>
                `;
            }
        }

        function filterBlockchainBatches() {
            const searchTerm = document.getElementById('searchBatch').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;

            filteredBlockchainBatches = allBlockchainBatches.filter(batch => {
                const matchesSearch = !searchTerm || (
                    batch.physicalAsset.assetId?.toLowerCase().includes(searchTerm) ||
                    batch.physicalAsset.material?.toLowerCase().includes(searchTerm)
                );

                const matchesStatus = !statusFilter || batch.status === parseInt(statusFilter);

                return matchesSearch && matchesStatus;
            });

            renderBatchTable(filteredBlockchainBatches, 'blockchainBatchTableBody', 'viewBlockchainBatchDetails');
        }

        function viewBlockchainBatchDetails(batchId) {
            const batch = allBlockchainBatches.find(b => b.id === batchId);
            if (!batch) return;

            const content = `
                <h2 style="margin-bottom: 24px;">Batch #${batch.id} Details</h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
                    <div class="card" style="padding: 20px;">
                        <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 16px; color: var(--scarlet);">üì¶ Physical Asset</h3>
                        <div style="font-size: 13px;">
                            <div style="margin-bottom: 8px;"><strong>Asset ID:</strong> ${batch.physicalAsset.assetId || 'N/A'}</div>
                            <div style="margin-bottom: 8px;"><strong>Material:</strong> ${batch.physicalAsset.material || 'N/A'}</div>
                            <div style="margin-bottom: 8px;"><strong>Composition:</strong> ${batch.physicalAsset.composition || 'N/A'}</div>
                            <div style="margin-bottom: 8px;"><strong>Weight:</strong> ${batch.physicalAsset.weight || 'N/A'}</div>
                            <div style="margin-bottom: 8px;"><strong>Batch Number:</strong> ${batch.physicalAsset.batchNumber || 'N/A'}</div>
                        </div>
                    </div>

                    <div class="card" style="padding: 20px;">
                        <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 16px; color: var(--scarlet);">üåç Tracer Information</h3>
                        <div style="font-size: 13px;">
                            <div style="margin-bottom: 8px;"><strong>Supplier:</strong> ${batch.tracer.supplier || 'N/A'}</div>
                            <div style="margin-bottom: 8px;"><strong>Farm Location:</strong> ${batch.tracer.farmLocation || 'N/A'}</div>
                            <div style="margin-bottom: 8px;"><strong>Country:</strong> ${batch.tracer.country || 'N/A'}</div>
                            <div style="margin-bottom: 8px;"><strong>GPS Coordinates:</strong> ${batch.tracer.gpsCoordinates || 'N/A'}</div>
                            <div style="margin-bottom: 8px;"><strong>Certifications:</strong> ${batch.tracer.certifications || 'N/A'}</div>
                        </div>
                    </div>
                </div>

                <div class="card" style="padding: 20px; margin-top: 20px;">
                    <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 16px;">‚ÑπÔ∏è Batch Status</h3>
                    <div style="font-size: 13px;">
                        <div style="margin-bottom: 8px;"><strong>Status:</strong> ${getStatusBadge(batch.status)}</div>
                        <div style="margin-bottom: 8px;"><strong>Created By:</strong> ${batch.createdByName || 'Unknown'}</div>
                        <div style="margin-bottom: 8px;"><strong>Created:</strong> ${formatDateTime(batch.createdAt)}</div>
                    </div>
                </div>

                <div style="margin-top: 20px; text-align: center;">
                    <button onclick="closeBatchModal()" class="btn-secondary">Close</button>
                </div>
            `;

            document.getElementById('batchModalContent').innerHTML = content;
            document.getElementById('batchModal').style.display = 'block';
        }

        function closeBatchModal(event) {
            if (!event || event.target.id === 'batchModal') {
                document.getElementById('batchModal').style.display = 'none';
            }
        }

        async function loadBlockchainInfo() {
            try {
                const response = await fetch('/api/blockchain/info');
                const data = await response.json();
                
                if (data.isReady) {
                    blockchainInfo = data;
                    document.getElementById('blockchainInfo').style.display = 'block';
                    document.getElementById('noBlockchain').style.display = 'none';
                    document.getElementById('networkName').value = data.network;
                    document.getElementById('chainId').value = data.chainId;
                    document.getElementById('contractAddress').value = data.contractAddress;
                } else {
                    document.getElementById('noBlockchain').innerHTML = `
                        <strong>‚ö†Ô∏è Blockchain Not Ready</strong><br>
                        ${data.message}<br><br>
                        <strong>Instructions:</strong><br>
                        1. Open terminal and run: <code>npm run blockchain:node</code><br>
                        2. In another terminal run: <code>npm run blockchain:deploy</code><br>
                        3. Restart the server to detect the deployed contract
                    `;
                }
            } catch (error) {
                console.error('Error loading blockchain info:', error);
                document.getElementById('noBlockchain').innerHTML = `
                    <strong>‚ùå Error:</strong> Could not connect to blockchain API
                `;
            }
        }

        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                alert('MetaMask is not installed! Please install MetaMask to use blockchain features.');
                return;
            }

            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAddress = accounts[0];
                
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();

                document.getElementById('userAddress').value = userAddress;
                document.getElementById('statusText').textContent = 'Connected';
                document.getElementById('connectionStatus').innerHTML = `
                    <div class="info-box" style="background: #e8f5e9; border-left: 4px solid #4caf50;">
                        <strong>Status:</strong> Connected<br>
                        <strong>Address:</strong> ${userAddress}
                    </div>
                `;
                
                document.getElementById('connectBtn').style.display = 'none';
                document.getElementById('disconnectBtn').style.display = 'inline-block';
                document.getElementById('registrationCard').style.display = 'block';

                // Check if user is registered
                await checkUserRegistration();
            } catch (error) {
                console.error('Error connecting wallet:', error);
                alert('Error connecting to MetaMask: ' + error.message);
            }
        }

        function disconnectWallet() {
            provider = null;
            signer = null;
            userAddress = null;

            document.getElementById('statusText').textContent = 'Not connected';
            document.getElementById('connectionStatus').innerHTML = `
                <div class="info-box" style="background: #f5f5f5; border-left: 4px solid #999;">
                    <strong>Status:</strong> Not connected
                </div>
            `;
            
            document.getElementById('connectBtn').style.display = 'inline-block';
            document.getElementById('disconnectBtn').style.display = 'none';
            document.getElementById('registrationCard').style.display = 'none';
            document.getElementById('userAddress').value = '';
        }

        async function checkUserRegistration() {
            if (!userAddress) return;

            try {
                const response = await fetch(`/api/blockchain/info`);
                const data = await response.json();
                
                // This is a simplified check - you might want to add an endpoint to check user registration
                document.getElementById('userStatus').innerHTML = `
                    <div class="info-box" style="background: #fff3e0; border-left: 4px solid #FF3300;">
                        <strong>Info:</strong> To register on the blockchain, fill in the form below
                    </div>
                `;
                document.getElementById('registrationForm').style.display = 'block';
            } catch (error) {
                console.error('Error checking registration:', error);
            }
        }

        async function registerUser() {
            const name = document.getElementById('userName').value.trim();
            const role = document.getElementById('userRole').value;

            if (!name || !role) {
                alert('Please fill in all fields');
                return;
            }

            if (!userAddress) {
                alert('Please connect your wallet first');
                return;
            }

            try {
                const response = await fetch('/api/blockchain/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, role, address: userAddress })
                });

                const result = await response.json();

                if (result.success) {
                    alert('Successfully registered on blockchain!\nTransaction: ' + result.transactionHash);
                    document.getElementById('registrationForm').style.display = 'none';
                    document.getElementById('userStatus').innerHTML = `
                        <div class="info-box" style="background: #e8f5e9; border-left: 4px solid #4caf50;">
                            <strong>‚úì Registered</strong><br>
                            Name: ${name}<br>
                            Role: ${role}<br>
                            Transaction: ${result.transactionHash}
                        </div>
                    `;
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Registration error:', error);
                alert('Error registering user: ' + error.message);
            }
        }

        // Check authentication on page load
        window.addEventListener('load', async () => {
            await checkAuthentication();
            loadBlockchainInfo();
            loadBlockchainBatches();
        });

        async function checkAuthentication() {
            try {
                const response = await fetch('/api/auth/session', {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (!data.loggedIn) {
                    window.location.href = 'login.html';
                    return;
                }

                currentUser = data.user;
                document.getElementById('username-display').textContent = currentUser.username;
                const roles = ['Producer', 'Manufacturer', 'Distributor', 'Certifier', 'Admin'];
                document.getElementById('role-display').textContent = roles[currentUser.role] || 'Unknown';
            } catch (error) {
                console.error('Auth check error:', error);
                window.location.href = 'login.html';
            }
        }

        async function logout() {
            try {
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Logout error:', error);
            }
        }
    </script>

    <!-- Include ethers.js for blockchain interactions -->
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
</body>

</html>
