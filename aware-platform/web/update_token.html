<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aware‚Ñ¢ Token Updater</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="aware-style.css">
    <script src="batches.js"></script>
    <script src="aware-sdk.js"></script>
</head>

<body>
    <div class="app">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <img src="aware-logo.png" alt="AWARE" style="width: 28px; height: 28px; display: inline-block; vertical-align: middle; margin-right: 8px;">
                AWARE‚Ñ¢
            </div>
            <div class="nav" id="sidebar-nav">
                <a href="index.html">Home</a>
                <a href="create_token.html">Create Token</a>
                <a href="update_token.html" class="active">Update Token</a>
            </div>
            <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid rgba(245,245,245,.1);">
                <div style="color: rgba(245,245,245,.6); font-size: 12px; margin-bottom: 8px;">
                    Logged in as: <strong id="username-display">-</strong>
                </div>
                <div style="color: rgba(245,245,245,.6); font-size: 12px; margin-bottom: 12px;">
                    Role: <strong id="role-display">-</strong>
                </div>
                <button onclick="logout()" class="btn-secondary" style="width: 100%; font-size: 13px; background: #FF3300; color: white; border-radius: 20px; border: none;">Logout</button>
            </div>
        </aside>

        <main class="main">
            <!-- Top Header -->
            <header class="topbar">
                <div class="topbar-inner">
                    <div class="page-head">
                        <div>
                            <h1>Update Token</h1>
                            <p>Update existing Aware‚Ñ¢ tokens with new information using AI support.</p>
                        </div>
                    </div>
                </div>
            </header>

            <section class="content">
                <div class="shell">
                    <div class="card--page">
                        <!-- Guide Section -->
                        <div style="margin-bottom: 25px;">
                            <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 8px; color: var(--text);">üìñ Guide</h3>
                            <h4 style="font-size: 15px; font-weight: 600; margin-bottom: 12px; color: var(--text);">Follow these steps to update an existing token</h4>
                            <div class="info-box" style="background: #fff3e0; border-left: 4px solid #FF3300;">
                                <strong>1.</strong> Select the batch you want to update<br>
                                <strong>2.</strong> Select a previous batch for AI prediction (optional)<br>
                                <strong>3.</strong> Describe what's different<br>
                                <strong>4.</strong> Click "Predict with AI" to auto-fill changes, or "Continue without AI" to manually update<br>
                                <strong>5.</strong> Review and update the data through the 6 sections<br>
                                <strong>6.</strong> Submit to update your tokens
                            </div>
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <span class="step-number">1</span>
                                Select batch to update
                            </div>
                            <label>Choose the batch you want to update:</label>

                <div class="filter-bar">
                    <input type="text" id="searchUpdateBatch" placeholder="üîç Search by Asset ID..."
                        oninput="filterUpdateBatches()">
                    <select id="updateCompositionFilter" onchange="filterUpdateBatches()">
                        <option value="">Filter by Composition</option>
                        <option value="Organic Silk">Organic Silk</option>
                        <option value="Recycled Cotton">Recycled Cotton</option>
                        <option value="Conventional Cotton">Conventional Cotton</option>
                        <option value="Regenerative Cotton">Regenerative Cotton</option>
                        <option value="Organic Cotton">Organic Cotton</option>
                        <option value="Recycled Polyester">Recycled Polyester</option>
                    </select>
                    <select id="updateStatusFilter" onchange="filterUpdateBatches()">
                        <option value="">Filter by Status</option>
                        <option value="0">Pending</option>
                        <option value="1">Approved</option>
                        <option value="2">Rejected</option>
                        <option value="3">Certified</option>
                    </select>
                </div>

                <div style="overflow-x: auto; margin-top: 15px;">
                    <table class="batch-table" id="updateBatchTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Color</th>
                                <th>Asset ID</th>
                                <th>Weight Kgs</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="updateBatchTableBody">
                        </tbody>
                    </table>
                </div>
                <div id="updateBatchPagination"></div>

                <div class="selected-batch-display" id="selectedUpdateBatchDisplay">
                    <h4>Selected batch to update:</h4>
                    <div class="batch-info" id="selectedUpdateBatchInfo"></div>
                </div>

                <div class="info-box">
                    üí° <strong>Tip:</strong> Select the batch you want to modify or update.
                </div>
                        </div>

                        <div class="step">
                            <div class="step-title">
                                <span class="step-number">2</span>
                                Select previous batch for AI prediction
                            </div>
                            <label>Choose a previously delivered batch:</label>

                <div class="filter-bar">
                    <input type="text" id="searchBatch" placeholder="üîç Search by Asset ID..."
                        oninput="filterBatches()">
                    <select id="compositionFilter" onchange="filterBatches()">
                        <option value="">Filter by Composition</option>
                        <option value="Organic Silk">Organic Silk</option>
                        <option value="Recycled Cotton">Recycled Cotton</option>
                        <option value="Conventional Cotton">Conventional Cotton</option>
                        <option value="Regenerative Cotton">Regenerative Cotton</option>
                        <option value="Organic Cotton">Organic Cotton</option>
                        <option value="Recycled Polyester">Recycled Polyester</option>
                    </select>
                    <select id="statusFilter" onchange="filterBatches()">
                        <option value="">Filter by Status</option>
                        <option value="0">Pending</option>
                        <option value="1">Approved</option>
                        <option value="2">Rejected</option>
                        <option value="3">Certified</option>
                    </select>
                </div>

                <div style="overflow-x: auto; margin-top: 15px;">
                    <table class="batch-table" id="batchTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Color</th>
                                <th>Asset ID</th>
                                <th>Weight Kgs</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="batchTableBody">
                        </tbody>
                    </table>
                </div>
                <div id="referenceBatchPagination"></div>

                <div class="selected-batch-display" id="selectedBatchDisplay">
                    <h4>Selected batch:</h4>
                    <div class="batch-info" id="selectedBatchInfo"></div>
                </div>

                <div class="info-box">
                    üí° <strong>Tip:</strong> Select the batch that most closely resembles your new batch. This helps
                    predict what data is needed.
                </div>
                        </div>

                        <div class="step">
                <div class="step-title">
                    <span class="step-number">3</span>
                    What's different?
                </div>
                <label for="changes">Describe the differences from the previous batch:</label>
                <textarea id="changes"
                    placeholder="Example: We now use 60% organic cotton and 40% recycled cotton. Total weight is 5000 kg. The color is now navy blue. New supplier: Cotton World from India. Added tracer..."></textarea>
                <div class="info-box">
                    üìù Mention all changes: composition %, colors, weight, suppliers, locations, certificates, tracer,
                    etc.
                </div>
            </div>

            <div class="button-group">
                <button class="btn" onclick="predictWithAI()">ü§ñ Predict with AI (Local Ollama)</button>
                <button class="btn btn-secondary" onclick="continueWithoutAI()">Continue without AI</button>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>AI is analyzing your changes and filling in the data...</p>
            </div>

            <div class="predicted-data" id="predictedData">
                <h3>‚ú® Predicted data - Check and correct if needed</h3>

                <!-- Progress Bar -->
                <div class="progress-bar">
                    <div class="step active" data-step="1">
                        <div class="step-number">1</div>
                        <div class="step-label">Token Type</div>
                    </div>
                    <div class="step-arrow">‚Üí</div>

                    <div class="step" data-step="2">
                        <div class="step-number">2</div>
                        <div class="step-label">Physical Asset</div>
                    </div>
                    <div class="step-arrow">‚Üí</div>

                    <div class="step" data-step="3">
                        <div class="step-number">3</div>
                        <div class="step-label">Tracer</div>
                    </div>
                    <div class="step-arrow">‚Üí</div>

                    <div class="step" data-step="4">
                        <div class="step-number">4</div>
                        <div class="step-label">Validation</div>
                    </div>
                    <div class="step-arrow">‚Üí</div>

                    <div class="step" data-step="5">
                        <div class="step-number">5</div>
                        <div class="step-label">Compliances</div>
                    </div>
                    <div class="step-arrow">‚Üí</div>

                    <div class="step" data-step="6">
                        <div class="step-number">6</div>
                        <div class="step-label">DPP</div>
                    </div>
                </div>

                <!-- Section 1: Token Type -->
                <div class="section active" id="section1">
                    <div class="field-label">1. Token Type</div>
                    <div class="field-value">
                        <label>Date:</label>
                        <input type="date" id="assetDate">

                        <label style="margin-top: 15px;">Production Facility *:</label>
                        <select id="productionFacility" onchange="updateDPP()">
                            <option value="">--Select from Producer Geo Locations--</option>
                            <option value="Wenzhou TIANCHENG Textile Co., Ltd - Zhejiang, China">Wenzhou TIANCHENG Textile Co., Ltd - Zhejiang, China</option>
                            <option value="Shanghai Hongda Manufacturing - Shanghai, China">Shanghai Hongda Manufacturing - Shanghai, China</option>
                        </select>

                        <label style="margin-top: 15px;">Value Chain Process (Main) *:</label>
                        <select id="valueChainMain" onchange="updateDPP()">
                            <option value="">--Select Value Chain Process (Main)--</option>
                            <option value="Raw Material Extraction">Raw Material Extraction</option>
                            <option value="Raw Material Processing">Raw Material Processing</option>
                            <option value="Material Production">Material Production</option>
                            <option value="Finished Production Assembly">Finished Production Assembly</option>
                        </select>

                        <label style="margin-top: 15px;">Value Chain Process (Sub) *:</label>
                        <select id="valueChainSub" onchange="updateDPP()">
                            <option value="">--Select Value Chain Process (Sub)--</option>
                            <option value="Fabric Weaving">Fabric Weaving</option>
                            <option value="Fabric Knitting">Fabric Knitting</option>
                        </select>

                        <label style="margin-top: 15px;">Aware‚Ñ¢ Output Token Type:</label>
                        <input type="text" id="tokenType" placeholder="e.g., Yarn" onchange="updateDPP()" oninput="updateDPP()">
                    </div>
                    <div class="navigation">
                        <div></div>
                        <button class="btn btn-primary" onclick="nextPredictedSection(2)">Save & Next ‚Üí</button>
                    </div>
                </div>

                <!-- Section 2: Physical Asset -->
                <div class="section" id="section2">
                    <div class="field-label">2. Physical Asset</div>
                    <div class="field-value">
                        <label>Material Specification *:</label>
                        <input type="text" id="materialSpec" placeholder="e.g., 16/1s">

                        <label style="margin-top: 15px;">Select Main Color *:</label>
                        <input type="color" id="selectMainColor" style="height: 40px; cursor: pointer;" onchange="updateColorName(this.value)">

                        <label style="margin-top: 15px;">Main Color *:</label>
                        <input type="text" id="mainColor" placeholder="e.g., Orange" onchange="updateDPP()" oninput="updateDPP()">

                        <script>
                        function hexToColorName(hex) {
                            const colorMap = {
                                '#FF0000': 'Red', '#FF3300': 'Scarlet', '#FF6600': 'Orange Red', '#FF9900': 'Dark Orange',
                                '#FFCC00': 'Orange', '#FFFF00': 'Yellow', '#CCFF00': 'Yellow Green', '#99FF00': 'Lime',
                                '#66FF00': 'Bright Green', '#33FF00': 'Green', '#00FF00': 'Pure Green', '#00FF33': 'Spring Green',
                                '#00FF66': 'Sea Green', '#00FF99': 'Aquamarine', '#00FFCC': 'Turquoise', '#00FFFF': 'Cyan',
                                '#00CCFF': 'Sky Blue', '#0099FF': 'Azure', '#0066FF': 'Blue', '#0033FF': 'Royal Blue',
                                '#0000FF': 'Pure Blue', '#3300FF': 'Indigo', '#6600FF': 'Purple', '#9900FF': 'Violet',
                                '#CC00FF': 'Magenta', '#FF00FF': 'Fuchsia', '#FF00CC': 'Pink Magenta', '#FF0099': 'Hot Pink',
                                '#FF0066': 'Deep Pink', '#FF0033': 'Pink Red', '#FFA500': 'Orange', '#FFD580': 'Light Orange',
                                '#ADD8E6': 'Light Blue', '#FFFFE0': 'Light Yellow', '#800080': 'Purple', '#F5F5DC': 'Natural',
                                '#FFFFFF': 'White', '#000000': 'Black', '#808080': 'Gray', '#C0C0C0': 'Silver',
                                '#800000': 'Maroon', '#008000': 'Green', '#000080': 'Navy', '#808000': 'Olive'
                            };
                            
                            const upperHex = hex.toUpperCase();
                            if (colorMap[upperHex]) return colorMap[upperHex];
                            
                            // Convert hex to RGB
                            const r = parseInt(hex.substr(1,2), 16);
                            const g = parseInt(hex.substr(3,2), 16);
                            const b = parseInt(hex.substr(5,2), 16);
                            
                            // Determine color based on RGB values
                            if (r > 200 && g > 200 && b > 200) return 'Light ' + ((r > g && r > b) ? 'Pink' : (g > r && g > b) ? 'Green' : 'Blue');
                            if (r < 50 && g < 50 && b < 50) return 'Dark ' + ((r > g && r > b) ? 'Red' : (g > r && g > b) ? 'Green' : 'Blue');
                            
                            if (r > g && r > b) return (r > 200) ? 'Light Red' : (r > 128) ? 'Red' : 'Dark Red';
                            if (g > r && g > b) return (g > 200) ? 'Light Green' : (g > 128) ? 'Green' : 'Dark Green';
                            if (b > r && b > g) return (b > 200) ? 'Light Blue' : (b > 128) ? 'Blue' : 'Dark Blue';
                            if (r > 128 && g > 128 && b < 100) return 'Yellow';
                            if (r > 128 && b > 128 && g < 100) return 'Purple';
                            if (g > 128 && b > 128 && r < 100) return 'Cyan';
                            
                            return hex;
                        }
                        
                        function updateColorName(hexValue) {
                            document.getElementById('mainColor').value = hexToColorName(hexValue);
                        }
                        </script>

                        <label style="margin-top: 15px;">Production Lot/ Batch No. *:</label>
                        <input type="text" id="batchNo" placeholder="e.g., 77839H8873">

                        <label style="margin-top: 15px;">Total Weight of the Products in Kgs(#Tokens) *:</label>
                        <input type="number" id="totalWeight" placeholder="e.g., 8500" onchange="updateDPP()" oninput="updateDPP()">

                        <label style="margin-top: 15px;">Composition *:</label>
                        <div id="compositionList"></div>
                        <button class="add-btn" onclick="addComposition()" style="margin-top: 10px;">+ Add Composition</button>

                        <div style="margin-top: 20px; padding: 15px; background: #f9f9f9; border-radius: 8px;">
                            <table style="width: 100%; font-size: 13px;">
                                <thead>
                                    <tr style="background: #e0e0e0;">
                                        <th style="padding: 8px; text-align: left;">Material</th>
                                        <th style="padding: 8px; text-align: left;">%</th>
                                        <th style="padding: 8px; text-align: left;">Sustainable</th>
                                        <th style="padding: 8px; text-align: left;">Claim</th>
                                        <th style="padding: 8px; text-align: left;">Feedstock Recycled</th>
                                        <th style="padding: 8px; text-align: left;">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="compositionTableBody">
                                    <tr>
                                        <td colspan="6" style="padding: 15px; text-align: center; color: #999;">No Data
                                            Available</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <label style="margin-top: 20px;"><strong>Used Aware‚Ñ¢ Assets / Materials *</strong></label>
                        <button class="add-btn" onclick="addAwareAsset()">Connect Aware‚Ñ¢ Assets and add other
                            material(s)</button>

                        <div id="awareAssetsList" style="margin-top: 15px;"></div>

                        <div style="margin-top: 15px; padding: 10px; background: #f0f4ff; border-radius: 4px;">
                            <strong>Total Input Materials:</strong> <span id="totalInputMaterials">8500</span> Kgs<br>
                            <strong>Remaining Tokens (kgs):</strong> <span id="remainingTokens">8500</span>
                        </div>

                        <div style="margin-top: 15px;">
                            <label><strong>Aware‚Ñ¢ Assets</strong></label>
                            <table style="width: 100%; font-size: 13px; margin-top: 10px;">
                                <thead>
                                    <tr style="background: #e0e0e0;">
                                        <th style="padding: 8px; text-align: left;">Token Type</th>
                                        <th style="padding: 8px; text-align: left;">Token ID</th>
                                        <th style="padding: 8px; text-align: left;">Used (kgs)</th>
                                        <th style="padding: 8px; text-align: left;">Waste (Kgs)</th>
                                    </tr>
                                </thead>
                                <tbody id="awareAssetsTableBody">
                                    <tr>
                                        <td colspan="4" style="padding: 15px; text-align: center; color: #999;">No Data
                                            Available</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div style="margin-top: 15px;">
                            <label><strong>Other Material</strong></label>
                            <table style="width: 100%; font-size: 13px; margin-top: 10px;">
                                <thead>
                                    <tr style="background: #e0e0e0;">
                                        <th style="padding: 8px; text-align: left;">Input Material</th>
                                        <th style="padding: 8px; text-align: left;">Total kgs. Used</th>
                                        <th style="padding: 8px; text-align: left;">Sustainable</th>
                                        <th style="padding: 8px; text-align: left;">Sustainability Claim</th>
                                        <th style="padding: 8px; text-align: left;">Feedstock Recycled</th>
                                    </tr>
                                </thead>
                                <tbody id="otherMaterialTableBody">
                                    <tr>
                                        <td colspan="5" style="padding: 15px; text-align: center; color: #999;">No Data
                                            Available</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <label style="margin-top: 15px;">Sustainable Process Claim:</label>
                        <div class="sustainability-toggle">
                            <span>No</span>
                            <div class="toggle-switch" id="sustainableClaimsToggle" onclick="toggleSustainableClaims()">
                            </div>
                            <span>Yes</span>
                        </div>
                        <div id="sustainableClaimsContent" style="display: none; margin-top: 10px;">
                            <input type="text" id="sustainableClaims" placeholder="e.g., Sustainable claim details">
                        </div>

                        <label style="margin-top: 15px;">Wet Processing:</label>
                        <div class="sustainability-toggle">
                            <span>No</span>
                            <div class="toggle-switch" id="wetProcessingToggle" onclick="toggleWetProcessing()"></div>
                            <span>Yes</span>
                        </div>
                        <div id="wetProcessingContent" style="display: none; margin-top: 10px;">
                            <select id="wetProcessingSelect">
                                <option value="">--Select Wet Processing--</option>
                                <option value="dyeing">Dyeing</option>
                                <option value="washing">Washing</option>
                                <option value="printing">Printing</option>
                                <option value="finishing">Finishing</option>
                            </select>
                        </div>

                        <div
                            style="margin-top: 20px; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px; font-size: 13px;">
                            <strong>‚ö†Ô∏è Important:</strong> Once you proceed from this page by clicking on "Save & Next"
                            button the selected Aware‚Ñ¢ assets will not be editable because they will get locked. If you
                            want to unlock them, please click Back to go to Aware‚Ñ¢ Token Type page, or else delete the
                            entire request and make a new one.
                        </div>
                    </div>
                    <div class="navigation">
                        <button class="btn btn-secondary" onclick="prevPredictedSection(1)">‚Üê Previous</button>
                        <button class="btn btn-primary" onclick="nextPredictedSection(3)">Save & Next ‚Üí</button>
                    </div>
                </div>

                <!-- Section 3: Tracer -->
                <div class="section" id="section3">
                    <div class="field-label">3. Tracer</div>
                    <div class="field-value">
                        <label>Aware‚Ñ¢ Asset ID:</label>
                        <input type="text" id="assetId"
                            placeholder="e.g., tiancheng - Yarn - 16/1s - 100% Organic Silk - Orange - 23443242342">

                        <label style="margin-top: 15px;">Tracer added:</label>
                        <div class="sustainability-toggle">
                            <span>No</span>
                            <div class="toggle-switch" id="tracerAddedToggle" onclick="toggleTracerAdded()"></div>
                            <span>Yes</span>
                        </div>

                        <div id="tracerTypeSection" style="display: none; margin-top: 15px;">
                            <label>Type of Tracer *:</label>
                            <div style="margin-top: 10px;">
                                <label><input type="radio" name="tracerType" value="aware"
                                        onchange="updateTracerFields()">
                                    Aware‚Ñ¢</label>
                                <label style="margin-left: 20px;"><input type="radio" name="tracerType" value="custom"
                                        onchange="updateTracerFields()"> Custom</label>
                            </div>

                            <div id="tracerDetails" style="margin-top: 15px;"></div>
                        </div>

                        <div
                            style="margin-top: 15px; padding: 15px; background: #f0f4ff; border-radius: 8px; font-size: 13px;">
                            We confirm that the Aware‚Ñ¢ tracer has been added to this asset during production, and that
                            the Aware‚Ñ¢ tracer is detectable in the same asset after production. We performed positive
                            scans with the Aware‚Ñ¢ spectrometer on the mentioned date, according to the Aware‚Ñ¢ sampling
                            plan of complete batch / lot.
                        </div>
                    </div>
                    <div class="navigation">
                        <button class="btn btn-secondary" onclick="prevPredictedSection(2)">‚Üê Previous</button>
                        <button class="btn btn-primary" onclick="nextPredictedSection(4)">Save & Next ‚Üí</button>
                    </div>
                </div>

                <!-- Section 4: Validation -->
                <div class="section" id="section4">
                    <div class="field-label">4. Validation</div>
                    <div class="field-value">
                        <label>List of Materials:</label>
                        <div style="margin-top: 10px; padding: 10px; background: #f9f9f9; border-radius: 4px;">
                            <small>Material | Claim | Weight kgs | Color | Feedstock Origin</small>
                        </div>

                        <label style="margin-top: 15px;">Validation:</label>
                        <p style="font-size: 13px; color: #666;">Choose how you want to validate this material</p>

                        <label style="margin-top: 15px;"><strong>Self - Validation</strong></label>
                        <button class="add-btn" onclick="addSelfValidation()">Add Self Validation</button>
                        <div id="selfValidationList"></div>

                        <label style="margin-top: 15px;"><strong>Guan Xu First Mile Traceability
                                Platform</strong></label>
                        <button class="add-btn" onclick="addGuanXu()">Upload Guan Xu Documentation</button>
                        <div id="guanXuList"></div>

                        <label style="margin-top: 15px;"><strong>STCP First Mile Traceability Platform</strong></label>
                        <button class="add-btn" onclick="addSTCP()">Upload STCP Documentation</button>
                        <div id="stcpList"></div>
                    </div>
                    <div class="navigation">
                        <button class="btn btn-secondary" onclick="prevPredictedSection(3)">‚Üê Previous</button>
                        <button class="btn btn-primary" onclick="nextPredictedSection(5)">Save & Next ‚Üí</button>
                    </div>
                </div>

                <!-- Section 5: Compliances -->
                <div class="section" id="section5">
                    <div class="field-label">5. Compliances</div>
                    <div class="field-value">
                        <div style="background: #f8f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h3 style="display: flex; align-items: center; font-size: 16px; margin-bottom: 15px;">
                                <span style="margin-right: 8px;">üåø</span> Environmental Scope Certificates
                            </h3>
                            <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 4px; overflow: hidden;">
                                <thead>
                                    <tr style="background: #f5f5f5;">
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e0e0e0;">Certification Name</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e0e0e0;">Description</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e0e0e0;">Status</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e0e0e0;">Valid Thru Date</th>
                                        <th style="padding: 12px; text-align: center; border-bottom: 2px solid #e0e0e0; width: 60px;"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="padding: 12px; border-bottom: 1px solid #f0f0f0;"><a href="#" style="color: #667eea;">GRS</a></td>
                                        <td style="padding: 12px; border-bottom: 1px solid #f0f0f0;">GRS</td>
                                        <td style="padding: 12px; border-bottom: 1px solid #f0f0f0;">VERIFIED</td>
                                        <td style="padding: 12px; border-bottom: 1px solid #f0f0f0;">31/08/2026</td>
                                        <td style="padding: 12px; border-bottom: 1px solid #f0f0f0; text-align: center;">
                                            <input type="checkbox" class="compliance-checkbox" data-cert="GRS" style="width: 18px; height: 18px; cursor: pointer;">
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div style="background: #f0f8ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h3 style="display: flex; align-items: center; font-size: 16px; margin-bottom: 15px;">
                                <span style="margin-right: 8px;">ü§ù</span> Social Compliance Certificates
                            </h3>
                            <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 4px; overflow: hidden;">
                                <thead>
                                    <tr style="background: #f5f5f5;">
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e0e0e0;">Certification Name</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e0e0e0;">Description</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e0e0e0;">Status</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e0e0e0;">Valid Thru Date</th>
                                        <th style="padding: 12px; text-align: center; border-bottom: 2px solid #e0e0e0; width: 60px;"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="padding: 12px; border-bottom: 1px solid #f0f0f0;"><a href="#" style="color: #667eea;">FairWear</a></td>
                                        <td style="padding: 12px; border-bottom: 1px solid #f0f0f0;">Social Cer...</td>
                                        <td style="padding: 12px; border-bottom: 1px solid #f0f0f0;">VERIFIED</td>
                                        <td style="padding: 12px; border-bottom: 1px solid #f0f0f0;">01/06/2027</td>
                                        <td style="padding: 12px; border-bottom: 1px solid #f0f0f0; text-align: center;">
                                            <input type="checkbox" class="compliance-checkbox" data-cert="FairWear" style="width: 18px; height: 18px; cursor: pointer;">
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div style="background: #fff8f0; padding: 20px; border-radius: 8px;">
                            <h3 style="display: flex; align-items: center; font-size: 16px; margin-bottom: 15px;">
                                <span style="margin-right: 8px;">üß™</span> Chemical Compliance Certificates
                            </h3>
                            <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 4px; overflow: hidden;">
                                <thead>
                                    <tr style="background: #f5f5f5;">
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e0e0e0;">Certification Name</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e0e0e0;">Description</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e0e0e0;">Status</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e0e0e0;">Valid Thru Date</th>
                                        <th style="padding: 12px; text-align: center; border-bottom: 2px solid #e0e0e0; width: 60px;"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="5" style="padding: 20px; text-align: center; color: #999;">No Data Available</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="navigation">
                        <button class="btn btn-secondary" onclick="prevPredictedSection(4)">‚Üê Previous</button>
                        <button class="btn btn-primary" onclick="nextPredictedSection(6)">Save & Next ‚Üí</button>
                    </div>
                </div>

                <!-- Section 6: DPP -->
                <div class="section" id="section6">
                    <div class="field-label">6. DPP (Digital Product Passport)</div>
                    <div class="field-value">
                        <div style="padding: 20px; background: #f9f9f9; border-radius: 8px;">
                            <h4>DPP Summary</h4>
                            <p style="margin-top: 10px;"><strong>Aware‚Ñ¢ Token Type:</strong> <span
                                    id="dppTokenType">-</span></p>
                            <p style="margin-top: 10px;"><strong>Aware‚Ñ¢ Asset ID:</strong> <span
                                    id="dppAssetId">-</span></p>
                            <p style="margin-top: 10px;"><strong>Material Composition:</strong> <span
                                    id="dppComposition">-</span></p>
                            <p style="margin-top: 10px;"><strong>Color:</strong> <span id="dppColor">-</span></p>
                            <p style="margin-top: 10px;"><strong>Quantity:</strong> <span id="dppQuantity">-</span> kgs
                            </p>
                            <p style="margin-top: 10px;"><strong>Producer:</strong> Wenzhou TIANCHENG Textile Co., Ltd.
                            </p>
                            <p style="margin-top: 10px;"><strong>Production Location:</strong> <span
                                    id="dppLocation">-</span></p>
                            <p style="margin-top: 10px;"><strong>Value Chain Process(Main):</strong> <span
                                    id="dppVCMain">-</span></p>
                            <p style="margin-top: 10px;"><strong>Value Chain Process(Sub):</strong> <span
                                    id="dppVCSub">-</span></p>
                            <p style="margin-top: 10px;"><strong>Tracer:</strong> <span id="dppTracer">-</span></p>
                            <p style="margin-top: 10px;"><strong>Certificates:</strong> <span
                                    id="dppCertificates">-</span></p>
                            <p style="margin-top: 15px; font-size: 18px; font-weight: bold; color: #667eea;"><span
                                    id="dppTokenCount">0</span> Aware‚Ñ¢ Tokens</p>
                            <p style="margin-top: 5px;"><strong>Status:</strong> <span id="dppStatus">Requested</span>
                            </p>
                        </div>
                    </div>
                    <div class="navigation">
                        <button class="btn btn-secondary" onclick="prevPredictedSection(5)">‚Üê Previous</button>
                        <button class="btn btn-primary" onclick="submitData()">Update Tokens</button>
                    </div>
                </div>
            </div>

            <div class="success-message" id="successMessage">
                ‚úÖ <strong>Success!</strong> Your tokens have been successfully updated. 1 kg material = 1 token.
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let currentData = null;
        let selectedUpdateBatch = null;
        let allBatches = [];
        let filteredUpdateBatches = [];
        let filteredReferenceBatches = [];
        let currentUpdatePage = 1;
        let currentReferencePage = 1;
        const batchesPerPage = 8;

        // Load batches from blockchain
        async function loadUpdateBatches() {
            try {
                allBatches = await loadBatchesGlobally();
                filteredUpdateBatches = [...allBatches];
                filteredReferenceBatches = [...allBatches];
                displayUpdateBatches(filteredUpdateBatches);
                displayBatches(filteredReferenceBatches);
            } catch (error) {
                console.error('Error loading batches:', error);
            }
        }

        // Display update batches in table (first step)
        function displayUpdateBatches(batches) {
            filteredUpdateBatches = batches;
            
            const startIndex = (currentUpdatePage - 1) * batchesPerPage;
            const endIndex = startIndex + batchesPerPage;
            const batchesToShow = filteredUpdateBatches.slice(startIndex, endIndex);

            if (batchesToShow.length === 0) {
                const tbody = document.getElementById('updateBatchTableBody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: var(--muted);">
                            No batches found
                        </td>
                    </tr>
                `;
                return;
            }

            renderBatchTable(batchesToShow, 'updateBatchTableBody', 'selectUpdateBatch');
            updateUpdatePagination(batches.length);
        }

        function updateUpdatePagination(totalBatches) {
            const totalPages = Math.ceil(totalBatches / batchesPerPage);
            const paginationDiv = document.getElementById('updateBatchPagination');
            
            if (totalPages <= 1) {
                paginationDiv.innerHTML = '';
                return;
            }
            
            let paginationHTML = '<div style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 20px;">';
            paginationHTML += `<button class="btn btn-secondary" onclick="changeUpdatePage(${currentUpdatePage - 1})" ${currentUpdatePage === 1 ? 'disabled' : ''} style="${currentUpdatePage === 1 ? 'opacity: 0.5; cursor: not-allowed;' : ''}">‚Üê Previous</button>`;
            paginationHTML += '<div style="display: flex; gap: 5px;">';
            for (let i = 1; i <= totalPages; i++) {
                paginationHTML += `<button class="btn ${i === currentUpdatePage ? 'btn-primary' : 'btn-secondary'}" onclick="changeUpdatePage(${i})" style="min-width: 40px;">${i}</button>`;
            }
            paginationHTML += '</div>';
            paginationHTML += `<button class="btn btn-secondary" onclick="changeUpdatePage(${currentUpdatePage + 1})" ${currentUpdatePage === totalPages ? 'disabled' : ''} style="${currentUpdatePage === totalPages ? 'opacity: 0.5; cursor: not-allowed;' : ''}">Next ‚Üí</button>`;
            paginationHTML += '</div>';
            paginationDiv.innerHTML = paginationHTML;
        }

        function changeUpdatePage(page) {
            const totalPages = Math.ceil(filteredUpdateBatches.length / batchesPerPage);
            if (page < 1 || page > totalPages) return;
            currentUpdatePage = page;
            displayUpdateBatches(filteredUpdateBatches);
        }

        // Filter update batches
        function filterUpdateBatches() {
            const searchTerm = document.getElementById('searchUpdateBatch').value.toLowerCase();
            const compositionFilter = document.getElementById('updateCompositionFilter').value;
            const statusFilter = document.getElementById('updateStatusFilter').value;

            let filtered = allBatches.filter(batch => {
                const matchesSearch = !searchTerm || (
                    batch.physicalAsset.assetId?.toLowerCase().includes(searchTerm) ||
                    batch.physicalAsset.material?.toLowerCase().includes(searchTerm)
                );
                const matchesComposition = !compositionFilter || 
                    batch.physicalAsset.composition?.includes(compositionFilter) ||
                    batch.physicalAsset.material?.includes(compositionFilter);
                const matchesStatus = !statusFilter || batch.status === parseInt(statusFilter);

                return matchesSearch && matchesComposition && matchesStatus;
            });

            currentUpdatePage = 1;
            displayUpdateBatches(filtered);
        }

        // Select a batch to update
        function selectUpdateBatch(batchId) {
            const batch = allBatches.find(b => b.id === batchId);
            if (!batch) return;

            selectedUpdateBatch = JSON.parse(JSON.stringify(batch));

            // Extract color from composition or material
            const color = batch.physicalAsset.composition?.match(/color[:\s]+([^,\n]+)/i)?.[1] || 
                         batch.physicalAsset.material?.match(/color[:\s]+([^,\n]+)/i)?.[1] || 
                         'N/A';

            // Display selected batch info in first step
            const display = document.getElementById('selectedUpdateBatchDisplay');
            const info = document.getElementById('selectedUpdateBatchInfo');

            info.innerHTML = `
                <strong>Date:</strong> ${formatDate(batch.createdAt)}<br>
                <strong>Type:</strong> ${batch.physicalAsset.material || 'N/A'}<br>
                <strong>Color:</strong> ${color}<br>
                <strong>Asset ID:</strong> ${batch.physicalAsset.assetId}<br>
                <strong>Weight:</strong> ${batch.physicalAsset.weight || 'N/A'}<br>
                <strong>Status:</strong> ${getStatusBadge(batch.status)}
            `;

            display.style.display = 'block';

            // Scroll to view
            display.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Display batches in table (for reference)
        function displayBatches(batches) {
            filteredReferenceBatches = batches;
            
            const startIndex = (currentReferencePage - 1) * batchesPerPage;
            const endIndex = startIndex + batchesPerPage;
            const batchesToShow = filteredReferenceBatches.slice(startIndex, endIndex);

            if (batchesToShow.length === 0) {
                const tbody = document.getElementById('batchTableBody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: var(--muted);">
                            No batches found
                        </td>
                    </tr>
                `;
                return;
            }

            renderBatchTable(batchesToShow, 'batchTableBody', 'selectBatch');
            updatePagination();
        }

        function updatePagination() {
            const totalPages = Math.ceil(filteredReferenceBatches.length / batchesPerPage);
            const paginationDiv = document.getElementById('referenceBatchPagination');
            
            if (totalPages <= 1) {
                paginationDiv.innerHTML = '';
                return;
            }
            
            let paginationHTML = '<div style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 20px;">';
            paginationHTML += '<button class="btn btn-secondary" onclick="changeReferencePage(' + (currentReferencePage - 1) + ')" ' + (currentReferencePage === 1 ? 'disabled' : '') + '>‚Üê Previous</button>';
            paginationHTML += '<div style="display: flex; gap: 5px;">';
            for (let i = 1; i <= totalPages; i++) {
                paginationHTML += '<button class="btn ' + (i === currentReferencePage ? 'btn-primary' : 'btn-secondary') + '" onclick="changeReferencePage(' + i + ')">' + i + '</button>';
            }
            paginationHTML += '</div>';
            paginationHTML += '<button class="btn btn-secondary" onclick="changeReferencePage(' + (currentReferencePage + 1) + ')" ' + (currentReferencePage === totalPages ? 'disabled' : '') + '>Next ‚Üí</button>';
            paginationHTML += '</div>';
            paginationDiv.innerHTML = paginationHTML;
        }

        function changeReferencePage(page) {
            const totalPages = Math.ceil(filteredReferenceBatches.length / batchesPerPage);
            if (page < 1 || page > totalPages) return;
            currentReferencePage = page;
            displayBatches(filteredReferenceBatches);
        }

        // Filter batches
        function filterBatches() {
            const searchTerm = document.getElementById('searchBatch').value.toLowerCase();
            const compositionFilter = document.getElementById('compositionFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;

            let filtered = allBatches.filter(batch => {
                const matchesSearch = !searchTerm || (
                    batch.physicalAsset.assetId?.toLowerCase().includes(searchTerm) ||
                    batch.physicalAsset.material?.toLowerCase().includes(searchTerm)
                );
                const matchesComposition = !compositionFilter || 
                    batch.physicalAsset.composition?.includes(compositionFilter) ||
                    batch.physicalAsset.material?.includes(compositionFilter);
                const matchesStatus = !statusFilter || batch.status === parseInt(statusFilter);

                return matchesSearch && matchesComposition && matchesStatus;
            });

            currentReferencePage = 1;
            displayBatches(filtered);
        }

        // Select a batch (for reference)
        function selectBatch(batchId) {
            const batch = allBatches.find(b => b.id === batchId);
            if (!batch) return;

            currentData = JSON.parse(JSON.stringify(batch));

            // Extract color from composition or material
            const color = batch.physicalAsset.composition?.match(/color[:\s]+([^,\n]+)/i)?.[1] || 
                         batch.physicalAsset.material?.match(/color[:\s]+([^,\n]+)/i)?.[1] || 
                         'N/A';

            // Display selected batch info
            const display = document.getElementById('selectedBatchDisplay');
            const info = document.getElementById('selectedBatchInfo');

            info.innerHTML = `
                <strong>Date:</strong> ${formatDate(batch.createdAt)}<br>
                <strong>Type:</strong> ${batch.physicalAsset.material || 'N/A'}<br>
                <strong>Color:</strong> ${color}<br>
                <strong>Asset ID:</strong> ${batch.physicalAsset.assetId}<br>
                <strong>Weight:</strong> ${batch.physicalAsset.weight || 'N/A'}<br>
                <strong>Status:</strong> ${getStatusBadge(batch.status)}
            `;

            display.style.display = 'block';

            // Scroll to changes section
            document.getElementById('changes').focus();
            document.getElementById('changes').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function loadBatchData() {
            const batchId = document.getElementById('previousBatch').value;
            if (batchId) {
                currentData = JSON.parse(JSON.stringify(batchData[batchId]));
            }
        }

        async function predictWithAI() {
            const changes = document.getElementById('changes').value;

            if (!currentData) {
                alert('Please select a previous batch first from the table above');
                return;
            }

            if (!changes.trim()) {
                alert('Please describe the differences from the previous batch');
                return;
            }

            document.getElementById('loading').style.display = 'block';
            document.getElementById('predictedData').style.display = 'none';

            try {
                // Send request to local proxy. The proxy will forward to Ollama running locally.
                const response = await fetch("/api/predict", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        messages: [
                            {
                                role: "user",
                                content: `You are an assistant for updating Aware‚Ñ¢ Token data for textile manufacturers.

Current batch data to update:
Asset ID: ${selectedUpdateBatch?.physicalAsset?.assetId || 'N/A'}
Material Type: ${selectedUpdateBatch?.physicalAsset?.material || 'N/A'}
Token Type: ${selectedUpdateBatch?.physicalAsset?.tokenType || 'N/A'}
Material Spec: ${selectedUpdateBatch?.physicalAsset?.materialSpec || 'N/A'}
Weight: ${selectedUpdateBatch?.physicalAsset?.weight || 'N/A'} kg
Color: ${selectedUpdateBatch?.physicalAsset?.mainColor || 'N/A'}
Color Hex: ${selectedUpdateBatch?.physicalAsset?.colorHex || 'N/A'}
Batch Number: ${selectedUpdateBatch?.physicalAsset?.batchNumber || 'N/A'}
Production Date: ${selectedUpdateBatch?.physicalAsset?.productionDate || 'N/A'}
Production Facility: ${selectedUpdateBatch?.physicalAsset?.productionFacility || 'N/A'}
Value Chain Main: ${selectedUpdateBatch?.physicalAsset?.valueChainMain || 'N/A'}
Value Chain Sub: ${selectedUpdateBatch?.physicalAsset?.valueChainSub || 'N/A'}
Composition: ${selectedUpdateBatch?.physicalAsset?.composition || 'N/A'}
Sustainable Claims: ${selectedUpdateBatch?.physicalAsset?.sustainableClaims || 'N/A'}
Wet Processing: ${selectedUpdateBatch?.physicalAsset?.wetProcessing || 'N/A'}

Tracer Info:
Tracer Type: ${selectedUpdateBatch?.tracer?.tracerType || 'N/A'}
Tracer Name: ${selectedUpdateBatch?.tracer?.tracerName || 'N/A'}
Tracer Added: ${selectedUpdateBatch?.tracer?.tracerAdded || 'N/A'}
Tracer Date: ${selectedUpdateBatch?.tracer?.tracerDate || 'N/A'}
Supplier: ${selectedUpdateBatch?.tracer?.supplier || 'N/A'}
Country: ${selectedUpdateBatch?.tracer?.country || 'N/A'}
Location: ${selectedUpdateBatch?.tracer?.farmLocation || 'N/A'}
Certifications: ${selectedUpdateBatch?.tracer?.certifications || 'N/A'}

Validation:
Type: ${selectedUpdateBatch?.validation?.validationType || 'N/A'}
Quality Grade: ${selectedUpdateBatch?.validation?.qualityGrade || 'N/A'}
Inspector: ${selectedUpdateBatch?.validation?.inspector || 'N/A'}

Compliance:
Selected Certs: ${selectedUpdateBatch?.compliance?.selectedCerts?.join(', ') || 'N/A'}
Sustainability Cert: ${selectedUpdateBatch?.compliance?.sustainabilityCert || 'N/A'}

Suppliers: ${selectedUpdateBatch?.suppliers?.map(s => `${s.name} (${s.location}) - ${s.weight}kg`).join('; ') || 'N/A'}
Composition Details: ${selectedUpdateBatch?.compositionDetails?.map(c => `${c.material} ${c.percentage}% - ${c.claim}`).join('; ') || 'N/A'}

Reference batch data (for comparison):
Asset ID: ${currentData?.physicalAsset?.assetId || 'N/A'}
Material Type: ${currentData?.physicalAsset?.material || 'N/A'}
Weight: ${currentData?.physicalAsset?.weight || 0} kg

The producer indicates these changes (may be in Dutch or English):
"${changes}"

TRANSLATION GUIDE:
- "afgenomen" = "decreased by" or "reduced by"
- "toegenomen" = "increased by"
- Example: "de batch met 50kg is afgenomen" means weight decreased by 50kg, so new weight = ${selectedUpdateBatch?.physicalAsset?.weight || 0} - 50 = ${(parseInt(selectedUpdateBatch?.physicalAsset?.weight) || 0) - 50}

CRITICAL INSTRUCTIONS:
1. If user says "afgenomen" (decreased), SUBTRACT that amount from original weight
2. If user says weight changed to a specific number, use that exact number
3. Return ONLY valid JSON matching the structure below
4. Fill ALL fields based on the changes described
5. NO markdown code blocks, NO explanations, ONLY the JSON
6. For fields not mentioned in changes, keep the original values from selectedUpdateBatch

Respond with valid JSON in this EXACT format:
{
  "tokenType": "${selectedUpdateBatch?.physicalAsset?.tokenType || 'Yarn'}",
  "materialSpec": "${selectedUpdateBatch?.physicalAsset?.materialSpec || ''}",
  "weight": ${parseInt(selectedUpdateBatch?.physicalAsset?.weight) || 0},
  "mainColor": "${selectedUpdateBatch?.physicalAsset?.mainColor || ''}",
  "colorHex": "${selectedUpdateBatch?.physicalAsset?.colorHex || '#FFFFFF'}",
  "batchNumber": "${selectedUpdateBatch?.physicalAsset?.batchNumber || 'BATCH-' + Date.now()}",
  "productionFacility": "${selectedUpdateBatch?.physicalAsset?.productionFacility || ''}",
  "valueChainMain": "${selectedUpdateBatch?.physicalAsset?.valueChainMain || ''}",
  "valueChainSub": "${selectedUpdateBatch?.physicalAsset?.valueChainSub || ''}",
  "sustainableClaims": "${selectedUpdateBatch?.physicalAsset?.sustainableClaims || ''}",
  "wetProcessing": "${selectedUpdateBatch?.physicalAsset?.wetProcessing || ''}",
  "composition": [{"material": "${selectedUpdateBatch?.physicalAsset?.material || 'Cotton'}", "percentage": 100, "sustainable": true, "claim": "Verified"}],
  "tracerType": "${selectedUpdateBatch?.tracer?.tracerType || 'aware'}",
  "tracerAdded": ${selectedUpdateBatch?.tracer?.tracerAdded || true},
  "tracerDate": "${selectedUpdateBatch?.tracer?.tracerDate || '2026-01-15'}",
  "tracerName": "${selectedUpdateBatch?.tracer?.tracerName || ''}",
  "suppliers": [{"name": "${selectedUpdateBatch?.tracer?.supplier || 'Supplier'}", "type": "Material Supplier", "location": "${selectedUpdateBatch?.tracer?.country || 'Netherlands'}", "weight": ${parseInt(selectedUpdateBatch?.physicalAsset?.weight) || 0}}],
  "compliances": ["${selectedUpdateBatch?.compliance?.selectedCerts?.join('","') || 'Blockchain Verified'}"],
  "validationType": "${selectedUpdateBatch?.validation?.validationType || 'Self-Validation'}"
}

Now update ALL fields based on the changes described above.`
                            }
                        ]
                    })
                });

                if (!response.ok) {
                    const errText = await response.text();
                    console.error('Prediction API returned error', response.status, errText);
                    // Fallback to local analysis if API fails
                    analyzeChanges(changes);
                    displayPredictedData();
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('predictedData').style.display = 'block';
                    document.getElementById('predictedData').scrollIntoView({ behavior: 'smooth', block: 'start' });
                    return;
                }

                let data;
                try {
                    data = await response.json();
                } catch (e) {
                    console.error('Failed to parse JSON response from prediction API');
                    // Fallback to local analysis
                    analyzeChanges(changes);
                    displayPredictedData();
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('predictedData').style.display = 'block';
                    document.getElementById('predictedData').scrollIntoView({ behavior: 'smooth', block: 'start' });
                    return;
                }

                // Try multiple known response shapes to extract the assistant text
                let aiResponse = '';
                if (data.content) {
                    if (Array.isArray(data.content)) {
                        const item = data.content.find(i => i.type === 'text');
                        aiResponse = item?.text || '';
                    } else if (typeof data.content === 'string') {
                        aiResponse = data.content;
                    }
                }
                aiResponse = aiResponse || data.completion?.content || data.completion || data.output?.text || data.choices?.[0]?.message?.content || data.choices?.[0]?.text || (typeof data === 'string' ? data : '');

                if (!aiResponse) {
                    console.error('Could not find assistant text in API response', data);
                    // Fallback to local analysis
                    analyzeChanges(changes);
                    displayPredictedData();
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('predictedData').style.display = 'block';
                    document.getElementById('predictedData').scrollIntoView({ behavior: 'smooth', block: 'start' });
                    return;
                }

                const cleanJson = aiResponse.replace(/```json|```/g, "").trim();

                let predictedData;
                try {
                    predictedData = JSON.parse(cleanJson);
                    // Update currentData with AI predictions - ALL fields
                    if (predictedData.weight) currentData.weight = predictedData.weight;
                    if (predictedData.name) currentData.name = predictedData.name;
                    if (predictedData.tokenType) currentData.tokenType = predictedData.tokenType;
                    if (predictedData.materialSpec) currentData.materialSpec = predictedData.materialSpec;
                    if (predictedData.mainColor) currentData.mainColor = predictedData.mainColor;
                    if (predictedData.colorHex) currentData.colorHex = predictedData.colorHex;
                    if (predictedData.batchNumber) currentData.batchNumber = predictedData.batchNumber;
                    if (predictedData.productionFacility) currentData.productionFacility = predictedData.productionFacility;
                    if (predictedData.valueChainMain) currentData.valueChainMain = predictedData.valueChainMain;
                    if (predictedData.valueChainSub) currentData.valueChainSub = predictedData.valueChainSub;
                    if (predictedData.sustainableClaims) currentData.sustainableClaims = predictedData.sustainableClaims;
                    if (predictedData.wetProcessing) currentData.wetProcessing = predictedData.wetProcessing;
                    if (predictedData.composition) currentData.composition = predictedData.composition;
                    if (predictedData.suppliers) currentData.suppliers = predictedData.suppliers;
                    if (predictedData.compliances) currentData.compliances = predictedData.compliances;
                    if (predictedData.tracerType) currentData.tracer = predictedData.tracerType;
                    if (predictedData.tracerAdded !== undefined) currentData.tracerAdded = predictedData.tracerAdded;
                    if (predictedData.tracerDate) currentData.tracerDate = predictedData.tracerDate;
                    if (predictedData.tracerName) currentData.tracerName = predictedData.tracerName;
                    if (predictedData.validationType) currentData.validationType = predictedData.validationType;
                    
                    displayPredictedData();
                } catch (e) {
                    console.error('Failed to parse JSON from assistant response', cleanJson);
                    // Fallback to local analysis
                    analyzeChanges(changes);
                    displayPredictedData();
                }

            } catch (error) {
                console.error('Error while calling prediction API:', error);
                // Fallback to local analysis if API call fails
                analyzeChanges(changes);
                displayPredictedData();
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('predictedData').style.display = 'block';
                document.getElementById('predictedData').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function continueWithoutAI() {
            if (!selectedUpdateBatch) {
                alert('Please select a batch to update first from step 1');
                return;
            }

            // Initialize empty currentData
            currentData = {
                composition: [],
                suppliers: [],
                compliances: [],
                tracer: 'aware'
            };
            
            // Change title to "Blank data"
            document.querySelector('#predictedData h3').textContent = 'Blank data';
            
            // Show predicted data section
            document.getElementById('predictedData').style.display = 'block';
            document.getElementById('predictedData').scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            // Display all sections with blank data
            displayBlankData();
        }
        
        function displayBlankData() {
            // Clear basic fields
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('assetDate').value = today;
            document.getElementById('tokenType').value = 'Yarn';
            document.getElementById('materialSpec').value = '';
            document.getElementById('mainColor').value = '';
            document.getElementById('totalWeight').value = '';
            document.getElementById('assetId').value = '';
            
            // Display empty composition list
            displayCompositions();
            
            // Initialize tracer section
            updateTracerFields();
            
            // Display empty compliances checkboxes
            displayCompliances();
            
            // Display empty suppliers
            displaySuppliers();
            
            // Update DPP
            updateDPP();
        }

        // Initialize on page load
        // Initialization moved to combined DOMContentLoaded below

        function analyzeChanges(changesText) {
            const text = changesText.toLowerCase();

            // Parse weight changes - improved to catch "weight is now X kg" or "is now X kg"
            const weightPatterns = [
                /(\d+(?:[.,]\d+)?)\s*(?:kg|kilogram)/i,
                /weight\s+(?:is\s+)?(?:now\s+)?(\d+(?:[.,]\d+)?)/i,
                /(?:is\s+)?now\s+(\d+(?:[.,]\d+)?)\s*kg/i
            ];
            for (const pattern of weightPatterns) {
                const match = text.match(pattern);
                if (match && match[1]) {
                    currentData.weight = Math.round(parseFloat(match[1].replace(',', '.')));
                    break;
                }
            }

            // Parse type/material changes - improved to catch "type has changed from X to Y" or "type is now Y"
            const typePatterns = [
                /type\s+(?:has\s+)?changed\s+(?:from\s+[\w\s]+\s+)?to\s+([\w\s]+?)(?:,|\.|and|$)/i,
                /type\s+is\s+(?:now\s+)?([\w\s]+?)(?:,|\.|and|$)/i,
                /(?:fabric|material|batch)\s+(?:is|called|named|:)?\s*([A-Z][^,\.]*(?:cotton|polyester|hemp|blend|fabric|linen)[^,\.]*)/i
            ];
            for (const pattern of typePatterns) {
                const match = changesText.match(pattern);
                if (match && match[1]) {
                    currentData.name = match[1].trim();
                    currentData.tokenType = match[1].trim();
                    break;
                }
            }

            // Parse material spec
            const specPatterns = [
                /(?:material\s+)?spec(?:ification)?[:\s]+([0-9\/]+s?)/i,
                /([0-9]+\/[0-9]+s)/i
            ];
            for (const pattern of specPatterns) {
                const match = changesText.match(pattern);
                if (match && match[1]) {
                    currentData.materialSpec = match[1].trim();
                    break;
                }
            }

            // Parse batch number
            const batchPatterns = [
                /batch\s+(?:number|no\.?|nr\.?)[:\s]+([A-Z0-9\-]+)/i,
                /lot\s+(?:number|no\.?|nr\.?)[:\s]+([A-Z0-9\-]+)/i
            ];
            for (const pattern of batchPatterns) {
                const match = changesText.match(pattern);
                if (match && match[1]) {
                    currentData.batchNumber = match[1].trim();
                    break;
                }
            }

            // Parse production facility
            const facilityPatterns = [
                /(?:production\s+)?facility[:\s]+([^,\.]+?)(?:,|\.|$)/i,
                /(?:produced\s+(?:at|in)|manufacturing)[:\s]+([^,\.]+?)(?:,|\.|$)/i
            ];
            for (const pattern of facilityPatterns) {
                const match = changesText.match(pattern);
                if (match && match[1]) {
                    const facility = match[1].trim();
                    // Match against available facilities
                    if (facility.toLowerCase().includes('wenzhou') || facility.toLowerCase().includes('tiancheng')) {
                        currentData.productionFacility = "Wenzhou TIANCHENG Textile Co., Ltd - Zhejiang, China";
                    } else if (facility.toLowerCase().includes('shanghai') || facility.toLowerCase().includes('hongda')) {
                        currentData.productionFacility = "Shanghai Hongda Manufacturing - Shanghai, China";
                    } else {
                        currentData.productionFacility = facility;
                    }
                    break;
                }
            }

            // Parse value chain process
            const vcMainPatterns = [
                /(?:value\s+chain|process)[:\s]+([^,\.]+?)(?:,|\.|$)/i
            ];
            for (const pattern of vcMainPatterns) {
                const match = changesText.match(pattern);
                if (match && match[1]) {
                    const process = match[1].trim().toLowerCase();
                    if (process.includes('extraction')) {
                        currentData.valueChainMain = "Raw Material Extraction";
                    } else if (process.includes('processing')) {
                        currentData.valueChainMain = "Raw Material Processing";
                    } else if (process.includes('production')) {
                        currentData.valueChainMain = "Material Production";
                    } else if (process.includes('assembly')) {
                        currentData.valueChainMain = "Finished Production Assembly";
                    }
                    break;
                }
            }

            // Parse value chain sub-process
            if (text.includes('weaving')) {
                currentData.valueChainSub = "Fabric Weaving";
            } else if (text.includes('knitting')) {
                currentData.valueChainSub = "Fabric Knitting";
            }

            // Parse sustainable claims
            const sustainablePatterns = [
                /sustainable\s+claim[:\s]+([^,\.]+?)(?:,|\.|$)/i,
                /sustainability[:\s]+([^,\.]+?)(?:,|\.|$)/i
            ];
            for (const pattern of sustainablePatterns) {
                const match = changesText.match(pattern);
                if (match && match[1]) {
                    currentData.sustainableClaims = match[1].trim();
                    break;
                }
            }

            // Parse wet processing
            if (text.includes('dyeing') || text.includes('dyed')) {
                currentData.wetProcessing = "dyeing";
            } else if (text.includes('washing') || text.includes('washed')) {
                currentData.wetProcessing = "washing";
            } else if (text.includes('printing') || text.includes('printed')) {
                currentData.wetProcessing = "printing";
            } else if (text.includes('finishing')) {
                currentData.wetProcessing = "finishing";
            }

            // Parse color - improved pattern to catch multiple formats
            const colorPatterns = [
                // "van paars naar rood" or "from purple to red"
                /(?:van|from)\s+(\w+)\s+(?:naar|to)\s+(\w+)/i,
                // "changed from X to Y" or "veranderd van X naar Y"
                /(?:kleur|color)\s+(?:has\s+)?(?:changed|veranderd|gewijzigd)\s+(?:from|van)\s+(?:\w+)\s+(?:to|naar)\s+(\w+)/i,
                // "moet veranderen naar rood" or "should change to red"
                /(?:moet\s+)?(?:veranderen|change)\s+(?:naar|to)\s+(\w+)/i,
                // "color is now red", "the color is red", "kleur is rood"
                /(?:the\s+)?(?:kleur|color)\s+is\s+(?:now\s+)?(\w+)/i,
                // "is now red" (when color is mentioned before)
                /(?:and\s+)?(?:the\s+)?(?:is\s+)?now\s+(red|blue|green|yellow|black|white|navy|purple|orange|pink|brown|gray|grey|beige|rood|blauw|groen|geel|zwart|wit|paars|oranje|roze|bruin)/i,
                // "color: red" or "kleur: rood"
                /(?:color|farbe|kleur|colore|colour)[:\s]+(\w+)/i
            ];
            // For pattern "van X naar Y", we want the second color (Y)
            let colorFound = false;
            for (let i = 0; i < colorPatterns.length; i++) {
                const match = changesText.match(colorPatterns[i]);
                if (match) {
                    // First pattern has 2 capture groups, we want the second one
                    if (i === 0 && match[2]) {
                        currentData.color = match[2].trim();
                        colorFound = true;
                        break;
                    } else if (match[1]) {
                        currentData.color = match[1].trim();
                        colorFound = true;
                        break;
                    }
                }
            }

            // Parse composition - improved regex patterns
            currentData.composition = [];

            // Look for organic cotton
            const organicCottonMatch = text.match(/(\d+)\s*%\s*organic\s+cotton/i);
            if (organicCottonMatch) {
                currentData.composition.push({
                    material: "Organic Cotton",
                    percentage: parseInt(organicCottonMatch[1]),
                    sustainable: true,
                    claim: "GOTS Certified"
                });
            }

            // Look for recycled cotton
            const recycledCottonMatch = text.match(/(\d+)\s*%\s*recycled\s+cotton/i);
            if (recycledCottonMatch) {
                currentData.composition.push({
                    material: "Recycled Cotton",
                    percentage: parseInt(recycledCottonMatch[1]),
                    sustainable: true,
                    claim: "Post-Consumer"
                });
            }

            // Look for regular cotton (if not organic or recycled mentioned)
            if (!organicCottonMatch && !recycledCottonMatch) {
                const cottonMatch = text.match(/(\d+)\s*%\s*(?:regular\s+)?cotton(?!\s*(?:recycled|organic))/i);
                if (cottonMatch) {
                    currentData.composition.push({
                        material: "Cotton",
                        percentage: parseInt(cottonMatch[1]),
                        sustainable: false,
                        claim: ""
                    });
                }
            }

            // Look for recycled polyester
            const recycledPolyesterMatch = text.match(/(\d+)\s*%\s*recycled\s+polyester/i);
            if (recycledPolyesterMatch) {
                currentData.composition.push({
                    material: "Recycled Polyester",
                    percentage: parseInt(recycledPolyesterMatch[1]),
                    sustainable: true,
                    claim: "Post-Consumer"
                });
            }

            // Look for regular polyester (if recycled not mentioned)
            if (!recycledPolyesterMatch) {
                const polyesterMatch = text.match(/(\d+)\s*%\s*polyester(?!\s+recycled)/i);
                if (polyesterMatch) {
                    currentData.composition.push({
                        material: "Polyester",
                        percentage: parseInt(polyesterMatch[1]),
                        sustainable: false,
                        claim: ""
                    });
                }
            }

            // Look for hemp
            const hempMatch = text.match(/(\d+)\s*%\s*(?:organic\s+)?hemp/i);
            if (hempMatch) {
                currentData.composition.push({
                    material: "Hemp",
                    percentage: parseInt(hempMatch[1]),
                    sustainable: true,
                    claim: text.includes('organic') && text.includes('hemp') ? "Organic" : "Sustainable"
                });
            }

            // Look for linen
            const linenMatch = text.match(/(\d+)\s*%\s*(?:organic\s+)?linen/i);
            if (linenMatch) {
                currentData.composition.push({
                    material: "Linen",
                    percentage: parseInt(linenMatch[1]),
                    sustainable: true,
                    claim: text.includes('organic') && text.includes('linen') ? "Organic" : "Sustainable"
                });
            }

            // Normalize percentages to 100%
            const totalPercentage = currentData.composition.reduce((sum, comp) => sum + comp.percentage, 0);
            if (totalPercentage > 0 && totalPercentage !== 100) {
                const scale = 100 / totalPercentage;
                currentData.composition.forEach(comp => {
                    comp.percentage = Math.round(comp.percentage * scale);
                });
            }

            // Parse supplier changes - improved
            if (text.includes('supplier') || text.includes('new')) {
                const supplierPattern = /(?:new\s+)?supplier[:\s]+(?:["'])?([a-zA-Z\s&.,\-()]+?)(?:["']|(?=\s+from|\s+in|,|location|type|address)|$)/gi;
                const matches = [...changesText.matchAll(supplierPattern)];

                if (matches.length > 0) {
                    matches.forEach((match, idx) => {
                        const name = match[1].trim();
                        if (name.length > 2 && !name.match(/^\d+/)) {
                            if (idx < currentData.suppliers.length) {
                                currentData.suppliers[idx].name = name;
                            } else {
                                currentData.suppliers.push({
                                    name: name,
                                    type: "Material Supplier",
                                    location: "",
                                    weight: 0
                                });
                            }
                        }
                    });
                }
            }

            // Parse location/country changes
            const countries = ['India', 'Turkey', 'China', 'Pakistan', 'France', 'Germany', 'Italy', 'USA', 'Egypt', 'Vietnam', 'Bangladesh', 'Indonesia'];
            countries.forEach(country => {
                if (text.includes(country.toLowerCase())) {
                    if (currentData.suppliers.length > 0) {
                        currentData.suppliers[0].location = country;
                    }
                }
            });

            // Parse supplier types
            const supplierTypes = {
                'cotton': 'Cotton Supplier',
                'polyester': 'Polyester Supplier',
                'hemp': 'Hemp Supplier',
                'linen': 'Linen Supplier',
                'recycled': 'Recycled Material Supplier',
                'organic': 'Organic Material Supplier'
            };

            Object.entries(supplierTypes).forEach(([key, type]) => {
                if (text.includes(key) && currentData.suppliers.length > 0) {
                    if (!currentData.suppliers[0].type.includes(type)) {
                        currentData.suppliers[0].type = type;
                    }
                }
            });

            // Parse tracer changes
            if (text.includes('aware tracer') || text.includes('aware‚Ñ¢')) {
                currentData.tracer = "aware";
                currentData.tracerDate = new Date().toISOString().split('T')[0];
            } else if (text.includes('custom tracer') || text.includes('tracer:')) {
                currentData.tracer = "custom";
                const tracerNameMatch = changesText.match(/(?:tracer\s*:?\s*|tracer\s+name\s*:?\s*)([^,\.]+)/i);
                if (tracerNameMatch) {
                    currentData.tracerName = tracerNameMatch[1].trim();
                }
            } else if (text.includes('no tracer')) {
                currentData.tracer = "none";
            }

            // Parse certificate changes - improved
            const certMap = {
                'gots': 'GOTS',
                'grs': 'GRS',
                'oeko': 'OEKO-TEX Standard 100',
                'eu organic': 'EU Organic',
                'fair trade': 'Fair Trade',
                'fsc': 'FSC',
                'bluesign': 'Bluesign'
            };

            currentData.compliances = [];
            Object.entries(certMap).forEach(([key, cert]) => {
                if (text.includes(key)) {
                    if (!currentData.compliances.includes(cert)) {
                        currentData.compliances.push(cert);
                    }
                }
            });

            // Distribute weight across suppliers
            if (currentData.composition.length > 0 && currentData.suppliers.length > 0) {
                const supplierCount = Math.min(currentData.composition.length, currentData.suppliers.length);
                const weightPerSupplier = Math.round(currentData.weight / supplierCount);
                for (let i = 0; i < supplierCount; i++) {
                    currentData.suppliers[i].weight = weightPerSupplier;
                }
            }
        }

        function displayPredictedData() {
            // Reset title to AI version
            document.querySelector('#predictedData h3').textContent = '‚ú® Predicted data - Check and correct if needed';
            
            // Set date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('assetDate').value = today;

            // Set ALL basic fields from currentData
            document.getElementById('tokenType').value = currentData.tokenType || currentData.name || currentData.type || 'Yarn';
            document.getElementById('materialSpec').value = currentData.materialSpec || currentData.name || '';
            document.getElementById('mainColor').value = currentData.mainColor || currentData.color || '';
            if (currentData.colorHex) {
                document.getElementById('selectMainColor').value = currentData.colorHex;
            }
            document.getElementById('totalWeight').value = currentData.weight || '';
            document.getElementById('batchNo').value = currentData.batchNumber || 'BATCH-' + Date.now();
            
            // Set production facility if available
            if (currentData.productionFacility) {
                const facilitySelect = document.getElementById('productionFacility');
                if (facilitySelect) facilitySelect.value = currentData.productionFacility;
            }
            
            // Set value chain fields
            if (currentData.valueChainMain) {
                const vcMainSelect = document.getElementById('valueChainMain');
                if (vcMainSelect) vcMainSelect.value = currentData.valueChainMain;
            }
            if (currentData.valueChainSub) {
                const vcSubSelect = document.getElementById('valueChainSub');
                if (vcSubSelect) vcSubSelect.value = currentData.valueChainSub;
            }
            
            // Set sustainable claims
            if (currentData.sustainableClaims) {
                const claimsToggle = document.getElementById('sustainableClaimsToggle');
                const claimsContent = document.getElementById('sustainableClaimsContent');
                const claimsInput = document.getElementById('sustainableClaims');
                if (claimsToggle && claimsContent && claimsInput) {
                    claimsToggle.classList.add('active');
                    claimsContent.style.display = 'block';
                    claimsInput.value = currentData.sustainableClaims;
                }
            }
            
            // Set wet processing
            if (currentData.wetProcessing) {
                const wetToggle = document.getElementById('wetProcessingToggle');
                const wetContent = document.getElementById('wetProcessingContent');
                const wetSelect = document.getElementById('wetProcessingSelect');
                if (wetToggle && wetContent && wetSelect) {
                    wetToggle.classList.add('active');
                    wetContent.style.display = 'block';
                    wetSelect.value = currentData.wetProcessing;
                }
            }
            
            // Set tracer fields
            if (currentData.tracerAdded || currentData.tracer) {
                const tracerToggle = document.getElementById('tracerAddedToggle');
                const tracerSection = document.getElementById('tracerTypeSection');
                if (tracerToggle && tracerSection) {
                    tracerToggle.classList.add('active');
                    tracerSection.style.display = 'block';
                    
                    // Set tracer type radio button
                    const tracerType = currentData.tracer || 'aware';
                    const tracerRadio = document.querySelector(`input[name="tracerType"][value="${tracerType}"]`);
                    if (tracerRadio) {
                        tracerRadio.checked = true;
                        updateTracerFields();
                        
                        // Set tracer date if available
                        if (currentData.tracerDate) {
                            setTimeout(() => {
                                const tracerDateInput = document.getElementById('tracerDate');
                                if (tracerDateInput) tracerDateInput.value = currentData.tracerDate;
                            }, 100);
                        }
                        
                        // Set custom tracer name if available
                        if (currentData.tracerName && tracerType === 'custom') {
                            setTimeout(() => {
                                const tracerNameInput = document.getElementById('tracerName');
                                if (tracerNameInput) tracerNameInput.value = currentData.tracerName;
                            }, 100);
                        }
                    }
                }
            }
            
            // Generate asset ID
            document.getElementById('assetId').value = 'tiancheng - ' + (currentData.tokenType || currentData.name || 'Yarn') + ' - ' + (currentData.materialSpec || '') + ' - ' + (currentData.mainColor || currentData.color || '') + ' - ' + Date.now();

            displayCompositions();
            displaySuppliers();
            displayCompliances();
            updateDPP();
        }

        function displayCompositions() {
            const list = document.getElementById('compositionList');
            list.innerHTML = '';
            
            if (!currentData.composition || currentData.composition.length === 0) {
                list.innerHTML = '<p style="color: #999; font-style: italic;">No compositions yet. Click "+ Add Composition" to add one.</p>';
                return;
            }
            
            currentData.composition.forEach((comp, index) => {
                const div = document.createElement('div');
                div.className = 'supplier-box';
                div.innerHTML = `
                    <div style="margin-bottom: 10px;"><strong>Material - ${index + 1}</strong></div>
                    <div class="input-row">
                        <label>Composition Material *:</label>
                        <select onchange="updateComposition(${index}, 'material', this.value)">
                            <option value="">-- Select Material --</option>
                            <option value="Organic Silk" ${comp.material === 'Organic Silk' ? 'selected' : ''}>Organic Silk</option>
                            <option value="Recycled Cotton" ${comp.material === 'Recycled Cotton' ? 'selected' : ''}>Recycled Cotton</option>
                            <option value="Conventional Cotton" ${comp.material === 'Conventional Cotton' ? 'selected' : ''}>Conventional Cotton</option>
                            <option value="Regenerative Cotton" ${comp.material === 'Regenerative Cotton' ? 'selected' : ''}>Regenerative Cotton</option>
                            <option value="Organic Cotton" ${comp.material === 'Organic Cotton' ? 'selected' : ''}>Organic Cotton</option>
                            <option value="Recycled Polyester" ${comp.material === 'Recycled Polyester' ? 'selected' : ''}>Recycled Polyester</option>
                        </select>
                    </div>
                    <div class="input-row" style="margin-top: 10px;">
                        <input type="number" value="${comp.percentage}" onchange="updateComposition(${index}, 'percentage', this.value)" placeholder="%" style="max-width: 80px;">
                        <span>%</span>
                    </div>
                    <div class="sustainability-toggle">
                        <span>Sustainable:</span>
                        <div class="toggle-switch ${comp.sustainable ? 'active' : ''}" onclick="toggleSustainability(${index})"></div>
                    </div>
                    <div style="margin-top: 10px;">
                        <label>Sustainability Claim *:</label>
                        <input type="text" value="${comp.claim}" onchange="updateComposition(${index}, 'claim', this.value)" placeholder="e.g., GOTS Certified, Post-Consumer">
                    </div>
                    <button class="remove-btn" onclick="removeComposition(${index})" style="width: 100%; margin-top: 10px;">‚úï Remove Material</button>
                `;
                list.appendChild(div);
            });
        }

        function toggleSustainability(index) {
            currentData.composition[index].sustainable = !currentData.composition[index].sustainable;
            displayCompositions();
        }

        function addComposition() {
            currentData.composition.push({ material: "", percentage: 0, sustainable: true, claim: "" });
            displayCompositions();
        }

        function removeComposition(index) {
            currentData.composition.splice(index, 1);
            displayCompositions();
        }

        function updateComposition(index, field, value) {
            if (field === 'percentage') {
                currentData.composition[index][field] = parseInt(value) || 0;
            } else {
                currentData.composition[index][field] = value;
            }
            updateDPP();
        }

        function updateTracerFields() {
            const tracerType = document.querySelector('input[name="tracerType"]:checked');
            const details = document.getElementById('tracerDetails');

            if (!tracerType) {
                details.innerHTML = '';
                return;
            }

            currentData.tracer = tracerType.value;

            if (tracerType.value === 'aware') {
                details.innerHTML = `
                    <label>Aware‚Ñ¢ Tracer Positive Scan Date *:</label>
                    <input type="date" id="tracerDate" value="${currentData.tracerDate || '2022-11-15'}" onchange="updateTracerDate(this.value)">
                    
                    <label style="margin-top: 15px;">Tracer Test Report:</label>
                    <input type="file" id="tracerFile" accept=".pdf">
                    <small style="display: block; margin-top: 5px; color: #999;">Upload PDF</small>
                `;
            } else if (tracerType.value === 'custom') {
                details.innerHTML = `
                    <label>Custom Tracer Name *:</label>
                    <input type="text" id="tracerName" placeholder="Enter custom tracer name" value="${currentData.tracerName || ''}" onchange="currentData.tracerName = this.value;">
                    
                    <label style="margin-top: 15px;">Tracer Test Report:</label>
                    <input type="file" id="tracerFile" accept=".pdf">
                    <small style="display: block; margin-top: 5px; color: #999;">Upload PDF</small>
                `;
            }
        }

        function updateTracerDate(date) {
            currentData.tracerDate = date;
        }

        function displaySuppliers() {
            const list = document.getElementById('suppliersList');
            list.innerHTML = '';
            
            if (!currentData.suppliers || currentData.suppliers.length === 0) {
                list.innerHTML = '<p style="color: #999; font-style: italic;">No suppliers yet. Click "+ Add Supplier" to add one.</p>';
                return;
            }
            
            currentData.suppliers.forEach((supplier, index) => {
                const div = document.createElement('div');
                div.className = 'supplier-box';
                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <strong>Supplier ${index + 1}</strong>
                        <button class="remove-btn" onclick="removeSupplier(${index})">‚úï Remove</button>
                    </div>
                    <div class="input-row" style="margin-top: 10px;">
                        <input type="text" value="${supplier.name}" onchange="updateSupplier(${index}, 'name', this.value)" placeholder="Supplier Name *">
                    </div>
                    <div class="input-row">
                        <input type="text" value="${supplier.type}" onchange="updateSupplier(${index}, 'type', this.value)" placeholder="Supplier Type (e.g., Cotton Supplier) *">
                    </div>
                    <div class="input-row">
                        <input type="text" value="${supplier.location}" onchange="updateSupplier(${index}, 'location', this.value)" placeholder="Location/Country *">
                        <input type="number" value="${supplier.weight}" onchange="updateSupplier(${index}, 'weight', this.value)" placeholder="Weight (kg) *" style="max-width: 150px;">
                    </div>
                    <small style="color: #666; display: block; margin-top: 10px;">üìÑ Required documents: Invoice, Packing List, Proof of Delivery</small>
                    <div class="input-row" style="margin-top: 10px;">
                        <input type="file" onchange="updateSupplier(${index}, 'invoice', this.files[0])" placeholder="Upload Invoice">
                        <input type="file" onchange="updateSupplier(${index}, 'packingList', this.files[0])" placeholder="Upload Packing List">
                        <input type="file" onchange="updateSupplier(${index}, 'delivery', this.files[0])" placeholder="Upload Proof of Delivery">
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function addSupplier() {
            currentData.suppliers.push({ name: "", type: "", location: "", weight: 0 });
            displaySuppliers();
        }

        function removeSupplier(index) {
            currentData.suppliers.splice(index, 1);
            displaySuppliers();
        }

        function updateSupplier(index, field, value) {
            if (field === 'weight') {
                currentData.suppliers[index][field] = parseInt(value) || 0;
            } else {
                currentData.suppliers[index][field] = value;
            }
        }

        function displayCompliances() {
            const list = document.getElementById('compliancesList');
            const allCerts = ['GOTS', 'GRS', 'OEKO-TEX Standard 100', 'EU Organic', 'Fair Trade', 'FSC', 'Bluesign'];

            let html = '<div class="checkbox-group">';
            allCerts.forEach(cert => {
                const isChecked = currentData.compliances && currentData.compliances.includes(cert);
                html += `<label>
                    <input type="checkbox" ${isChecked ? 'checked' : ''} onchange="toggleCompliance('${cert}', this.checked)"> ${cert}
                </label>`;
            });
            html += '</div>';
            list.innerHTML = html;
        }

        function toggleCompliance(cert, checked) {
            if (checked && !currentData.compliances.includes(cert)) {
                currentData.compliances.push(cert);
            } else if (!checked) {
                currentData.compliances = currentData.compliances.filter(c => c !== cert);
            }
        }

        function addSelfValidation() {
            const list = document.getElementById('selfValidationList');
            const index = list.children.length;
            const div = document.createElement('div');
            div.className = 'supplier-box';
            div.innerHTML = `
                <div style="margin-bottom: 10px;"><strong>Source - ${index + 1}</strong></div>
                
                <label>Material:</label>
                <input type="text" placeholder="e.g., Silk" style="margin-bottom: 10px;">
                
                <label>Claim:</label>
                <input type="text" placeholder="e.g., Organic" style="margin-bottom: 10px;">
                
                <label>Weight kgs:</label>
                <input type="number" placeholder="e.g., 4534" style="margin-bottom: 10px;">
                
                <label>Kgs *:</label>
                <input type="number" placeholder="kgs" style="margin-bottom: 10px;">
                
                <label>Feedstock Type *:</label>
                <select style="margin-bottom: 10px;">
                    <option value="">-- Select Feedstock Type --</option>
                    <option value="Organic">Organic</option>
                    <option value="Recycled">Recycled</option>
                    <option value="Conventional">Conventional</option>
                    <option value="Regenerative">Regenerative</option>
                </select>
                
                <label>Feedstock Source Type *:</label>
                <select style="margin-bottom: 10px;">
                    <option value="">-- Select Source Type --</option>
                    <option value="Farm">Farm</option>
                    <option value="Recycling Facility">Recycling Facility</option>
                    <option value="Manufacturing Plant">Manufacturing Plant</option>
                    <option value="Supplier">Supplier</option>
                </select>
                
                <label>Source Name *:</label>
                <select style="margin-bottom: 10px;">
                    <option value="">-- Select Source Name --</option>
                    <option value="Green Valley Organic Farm">Green Valley Organic Farm</option>
                    <option value="EcoSource Recycling Center">EcoSource Recycling Center</option>
                    <option value="Sustainable Fibers Ltd">Sustainable Fibers Ltd</option>
                    <option value="BioTextile Industries">BioTextile Industries</option>
                    <option value="Pure Cotton Collective">Pure Cotton Collective</option>
                    <option value="Regenerative Farming Co-op">Regenerative Farming Co-op</option>
                </select>
                
                <label>Address:</label>
                <input type="text" placeholder="Address" style="margin-bottom: 10px;">
                
                <label>Source Certification:</label>
                <select style="margin-bottom: 10px;">
                    <option value="">-- Select Certification --</option>
                    <option value="GOTS">GOTS</option>
                    <option value="GRS">GRS</option>
                    <option value="OEKO-TEX">OEKO-TEX</option>
                    <option value="EU Organic">EU Organic</option>
                    <option value="Fair Trade">Fair Trade</option>
                    <option value="FSC">FSC</option>
                    <option value="Bluesign">Bluesign</option>
                </select>
                
                <label>Source Invoice No. *:</label>
                <input type="text" placeholder="e.g., 77829H23" style="margin-bottom: 10px;">
                
                <label>Source Invoice Date *:</label>
                <input type="date" style="margin-bottom: 10px;">
                
                <label>Invoice:</label>
                <input type="file" accept=".pdf" style="margin-bottom: 10px;">
                <small style="display: block; margin-top: -5px; margin-bottom: 10px; color: #999;">Upload PDF</small>
                
                <label>Packing List:</label>
                <input type="file" accept=".pdf" style="margin-bottom: 10px;">
                <small style="display: block; margin-top: -5px; margin-bottom: 10px; color: #999;">Upload PDF</small>
                
                <label>Proof of Delivery:</label>
                <input type="file" accept=".pdf" style="margin-bottom: 10px;">
                <small style="display: block; margin-top: -5px; margin-bottom: 10px; color: #999;">Upload PDF</small>
                
                <label>Lab Testing:</label>
                <input type="file" accept=".pdf" style="margin-bottom: 10px;">
                <small style="display: block; margin-top: -5px; margin-bottom: 10px; color: #999;">Upload PDF</small>
                
                <label>Certificate Name 1:</label>
                <input type="file" accept=".pdf" style="margin-bottom: 10px;">
                <small style="display: block; margin-top: -5px; margin-bottom: 10px; color: #999;">Upload PDF</small>
                
                <label>Certificate Name 2:</label>
                <input type="file" accept=".pdf" style="margin-bottom: 10px;">
                <small style="display: block; margin-top: -5px; margin-bottom: 10px; color: #999;">Upload PDF</small>
                
                <label>Certificate Name 3:</label>
                <input type="file" accept=".pdf" style="margin-bottom: 10px;">
                <small style="display: block; margin-top: -5px; margin-bottom: 10px; color: #999;">Upload PDF</small>
                
                <label>Other Document Name:</label>
                <input type="file" accept=".pdf" style="margin-bottom: 10px;">
                <small style="display: block; margin-top: -5px; margin-bottom: 10px; color: #999;">Upload PDF</small>
                
                <label>Full Name *:</label>
                <input type="text" placeholder="User Full Name" style="margin-bottom: 10px;">
                
                <div style="margin-top: 10px; padding: 10px; background: #f0f4ff; border-radius: 4px; font-size: 12px;">
                    <label style="display: flex; align-items: start; gap: 8px;">
                        <input type="checkbox" style="width: auto; margin-top: 3px;">
                        <span>I, declare on behalf of my company, that the information I provided is true and correct and that I have used this sustainable feedstock to produce the assets I want to tokenize by this application. I also declare that this sustainable feedstock is from genuine organic or recycled origin, is from non-GMO resources, and do not contain pesticides.</span>
                    </label>
                </div>
                
                <button class="remove-btn" onclick="this.parentElement.remove()" style="width: 100%; margin-top: 10px;">‚úï Remove</button>
            `;
            list.appendChild(div);
        }

        function addGuanXu() {
            const list = document.getElementById('guanXuList');
            const div = document.createElement('div');
            div.className = 'supplier-box';
            div.innerHTML = `
                <div style="margin-bottom: 10px;"><strong>Guan Xu Documentation</strong></div>
                
                <label>Upload PDF from Guan Xu *:</label>
                <input type="file" accept=".pdf" style="margin-bottom: 10px;">
                <small style="display: block; margin-top: -5px; margin-bottom: 10px; color: #999;">Upload PDF</small>
                
                <div style="margin-top: 10px; padding: 10px; background: #f9f9f9; border-radius: 4px; font-size: 13px;">
                    <p><strong>Material:</strong> Silk</p>
                    <p><strong>Claim:</strong> Organic</p>
                    <p><strong>Weight kgs:</strong> 4534</p>
                    <p><strong>Color:</strong> -</p>
                    <p><strong>Feedstock Origin:</strong> N/A</p>
                </div>
                
                <label style="margin-top: 15px;">Full Name *:</label>
                <input type="text" placeholder="User Full Name" style="margin-bottom: 10px;">
                
                <div style="margin-top: 10px; padding: 10px; background: #f0f4ff; border-radius: 4px; font-size: 12px;">
                    <label style="display: flex; align-items: start; gap: 8px;">
                        <input type="checkbox" style="width: auto; margin-top: 3px;">
                        <span>I, declare on behalf of my company, that the information I provided is true and correct and that I have used this sustainable feedstock to produce the assets I want to tokenize by this application. I also declare that this sustainable feedstock is from genuine organic or recycled origin, is from non-GMO resources, and do not contain pesticides.</span>
                    </label>
                </div>
                
                <button class="remove-btn" onclick="this.parentElement.remove()" style="width: 100%; margin-top: 10px;">‚úï Remove</button>
            `;
            list.appendChild(div);
        }

        function addSTCP() {
            const list = document.getElementById('stcpList');
            const div = document.createElement('div');
            div.className = 'supplier-box';
            div.innerHTML = `
                <div style="margin-bottom: 10px;"><strong>STCP Documentation</strong></div>
                
                <label>Upload PDF from STCP *:</label>
                <input type="file" accept=".pdf" style="margin-bottom: 10px;">
                <small style="display: block; margin-top: -5px; margin-bottom: 10px; color: #999;">Upload PDF</small>
                
                <div style="margin-top: 10px; padding: 10px; background: #f9f9f9; border-radius: 4px; font-size: 13px;">
                    <p><strong>Material:</strong> Silk</p>
                    <p><strong>Claim:</strong> Organic</p>
                    <p><strong>Weight kgs:</strong> 4534</p>
                    <p><strong>Color:</strong> -</p>
                    <p><strong>Feedstock Origin:</strong> N/A</p>
                </div>
                
                <label style="margin-top: 15px;">Full Name *:</label>
                <input type="text" placeholder="User Full Name" style="margin-bottom: 10px;">
                
                <div style="margin-top: 10px; padding: 10px; background: #f0f4ff; border-radius: 4px; font-size: 12px;">
                    <label style="display: flex; align-items: start; gap: 8px;">
                        <input type="checkbox" style="width: auto; margin-top: 3px;">
                        <span>I, declare on behalf of my company, that the information I provided is true and correct and that I have used this sustainable feedstock to produce the assets I want to tokenize by this application. I also declare that this sustainable feedstock is from genuine organic or recycled origin, is from non-GMO resources, and do not contain pesticides.</span>
                    </label>
                </div>
                
                <button class="remove-btn" onclick="this.parentElement.remove()" style="width: 100%; margin-top: 10px;">‚úï Remove</button>
            `;
            list.appendChild(div);
        }

        function saveSection(sectionNumber) {
            alert('Section ' + sectionNumber + ' saved! You can continue to the next section.');
            updateDPP();
        }

        function updateDPP() {
            if (!currentData) return;
            
            // Update DPP summary with current data
            const dppTokenType = document.getElementById('dppTokenType');
            const dppAssetId = document.getElementById('dppAssetId');
            const dppComposition = document.getElementById('dppComposition');
            const dppColor = document.getElementById('dppColor');
            const dppQuantity = document.getElementById('dppQuantity');
            const dppTokenCount = document.getElementById('dppTokenCount');
            const dppVCMain = document.getElementById('dppVCMain');
            const dppVCSub = document.getElementById('dppVCSub');
            const dppTracer = document.getElementById('dppTracer');
            const dppCertificates = document.getElementById('dppCertificates');
            const dppLocation = document.getElementById('dppLocation');
            
            if (dppTokenType) dppTokenType.textContent = document.getElementById('tokenType')?.value || '-';
            if (dppAssetId) dppAssetId.textContent = document.getElementById('assetId')?.value || '-';

            // Composition
            let compositionText = '';
            if (currentData.composition && currentData.composition.length > 0) {
                compositionText = currentData.composition.map(comp => 
                    comp.material + ' (' + comp.percentage + '%)'
                ).join(', ');
            }
            if (dppComposition) dppComposition.textContent = compositionText || '-';

            if (dppColor) dppColor.textContent = document.getElementById('mainColor')?.value || '-';

            const weight = document.getElementById('totalWeight')?.value;
            if (dppQuantity) dppQuantity.textContent = weight || '0';
            if (dppTokenCount) dppTokenCount.textContent = weight || '0';

            const vcMain = document.getElementById('valueChainMain')?.value;
            const vcSub = document.getElementById('valueChainSub')?.value;
            if (dppVCMain) dppVCMain.textContent = vcMain || '-';
            if (dppVCSub) dppVCSub.textContent = vcSub || '-';
            
            const productionFacility = document.getElementById('productionFacility')?.value;
            if (dppLocation) dppLocation.textContent = productionFacility || '-';

            const tracerType = document.querySelector('input[name="tracerType"]:checked');
            if (dppTracer) dppTracer.textContent = tracerType ? tracerType.value : '-';

            if (dppCertificates && currentData.compliances) {
                dppCertificates.textContent = currentData.compliances.join(', ') || '-';
            }
        }
        
        // Auto-update DPP on input changes
        document.addEventListener('DOMContentLoaded', function() {
            const inputs = ['tokenType', 'assetId', 'mainColor', 'totalWeight', 'valueChainMain', 'valueChainSub', 'productionFacility'];
            inputs.forEach(id => {
                const elem = document.getElementById(id);
                if (elem) {
                    elem.addEventListener('change', updateDPP);
                    elem.addEventListener('input', updateDPP);
                }
            });
        });

        function toggleSustainableClaims() {
            const toggle = document.getElementById('sustainableClaimsToggle');
            const content = document.getElementById('sustainableClaimsContent');

            toggle.classList.toggle('active');

            if (toggle.classList.contains('active')) {
                content.style.display = 'block';
            } else {
                content.style.display = 'none';
            }
        }

        function toggleWetProcessing() {
            const toggle = document.getElementById('wetProcessingToggle');
            const content = document.getElementById('wetProcessingContent');

            toggle.classList.toggle('active');

            if (toggle.classList.contains('active')) {
                content.style.display = 'block';
            } else {
                content.style.display = 'none';
            }
        }

        function toggleTracerAdded() {
            const toggle = document.getElementById('tracerAddedToggle');
            const section = document.getElementById('tracerTypeSection');

            toggle.classList.toggle('active');

            if (toggle.classList.contains('active')) {
                section.style.display = 'block';
            } else {
                section.style.display = 'none';
                // Reset tracer type selection
                const radios = document.querySelectorAll('input[name="tracerType"]');
                radios.forEach(radio => radio.checked = false);
                document.getElementById('tracerDetails').innerHTML = '';
            }
        }

        function addAwareAsset() {
            const list = document.getElementById('awareAssetsList');
            const index = list.children.length + 1;
            const div = document.createElement('div');
            div.className = 'supplier-box';
            div.innerHTML = `
                <div style="margin-bottom: 10px;"><strong>Material - ${index}</strong></div>
                
                <label>Aware‚Ñ¢ Asset:</label>
                <div style="margin-top: 10px;">
                    <label>Aware‚Ñ¢ Token Type *:</label>
                    <select style="margin-bottom: 10px;">
                        <option value="">Pellet</option>
                        <option value="yarn">Yarn</option>
                        <option value="fabric">Fabric</option>
                        <option value="fiber">Fiber</option>
                    </select>
                    
                    <label>Select Aware‚Ñ¢ Asset ID *:</label>
                    <select style="margin-bottom: 10px;">
                        <option value="">Please select Aware‚Ñ¢ Asset ID</option>
                        <option value="tiancheng-yarn-silk-1736912141681">tiancheng - Yarn - Purple - 1736912141681</option>
                        <option value="tiancheng-fabric-cotton-1736912089234">tiancheng - Fabric - Natural - 1736912089234</option>
                        <option value="tiancheng-yarn-blue-1736911892745">tiancheng - Yarn - Light Blue - 1736911892745</option>
                        <option value="hongda-fiber-white-1736910234567">hongda - Fiber - White - 1736910234567</option>
                        <option value="hongda-pellet-green-1736909876543">hongda - Pellet - Green - 1736909876543</option>
                    </select>
                    
                    <label>Tokens in Wallet (kgs) *:</label>
                    <input type="number" value="0" style="margin-bottom: 10px;">
                    
                    <label>Used (kgs) *:</label>
                    <input type="number" value="0" style="margin-bottom: 10px;">
                    
                    <label>Waste (kgs) *:</label>
                    <input type="number" value="0" style="margin-bottom: 10px;">
                    
                    <label>Token Deduction (kgs) *:</label>
                    <input type="number" value="0" style="margin-bottom: 10px;">
                    
                    <label>Token Balance (kgs):</label>
                    <input type="number" value="0" readonly style="margin-bottom: 10px; background: #f5f5f5;">
                </div>
                
                <button class="remove-btn" onclick="this.parentElement.remove()" style="width: 100%; margin-top: 10px;">‚úï Remove</button>
            `;
            list.appendChild(div);
        }

        function submitData() {
            const weight = document.getElementById('totalWeight').value;

            if (!weight) {
                alert('Please fill in the total weight');
                return;
            }

            if (currentData.composition.length === 0) {
                alert('Please add at least one material to the composition');
                return;
            }

            // Collect all data from the form
            const submissionData = {
                date: document.getElementById('assetDate').value || new Date().toISOString().split('T')[0],
                productionFacility: document.getElementById('productionFacility').value || 'Default Facility',
                valueChainProcessMain: document.getElementById('valueChainMain').value || 'Spinning',
                valueChainProcessSub: document.getElementById('valueChainSub').value || 'Ring Spinning',
                awareTokenType: document.getElementById('tokenType').value || 'Yarn',
                materialSpecification: document.getElementById('materialSpec').value || 'Standard',
                mainColorSelected: document.getElementById('selectMainColor').value || '#FFA500',
                mainColorText: document.getElementById('mainColor').value || 'Orange',
                productionLotBatchNo: document.getElementById('batchNo').value || 'BATCH-' + Date.now(),
                totalWeightKgs: parseInt(weight),
                sustainableProcessClaims: document.getElementById('sustainableClaimsToggle') ? document.getElementById('sustainableClaimsToggle').classList.contains('active') : false,
                wetProcessing: document.getElementById('wetProcessingToggle') ? document.getElementById('wetProcessingToggle').classList.contains('active') : false,
                awareAssetId: document.getElementById('assetId').value || 'asset-' + Date.now(),
                tracerAdded: document.getElementById('tracerAddedToggle') ? document.getElementById('tracerAddedToggle').classList.contains('active') : false,
                materials: currentData.composition.map(comp => ({
                    compositionMaterial: comp.material || 'Unknown Material',
                    percentage: comp.percentage || 0,
                    sustainable: comp.sustainable || false,
                    sustainabilityClaim: comp.claim || 'None',
                    feedstockRecycledMaterials: null
                })),
                validationMethod: 'SelfValidation', // Default value
                certificates: {
                    environmental: currentData.compliances || [],
                    social: [],
                    chemical: []
                }
            };

            // Validate required fields
            const missingFields = [];
            if (!submissionData.date) missingFields.push('Date');
            if (!submissionData.productionFacility) missingFields.push('Production Facility');
            if (!submissionData.valueChainProcessMain) missingFields.push('Value Chain Process (Main)');
            if (!submissionData.valueChainProcessSub) missingFields.push('Value Chain Process (Sub)');
            if (!submissionData.materialSpecification) missingFields.push('Material Specification');
            if (!submissionData.mainColorSelected) missingFields.push('Main Color');
            if (!submissionData.productionLotBatchNo) missingFields.push('Batch Number');
            
            if (missingFields.length > 0) {
                alert('Please fill in the following required fields:\n\n' + missingFields.join('\n'));
                return;
            }

            // Add tracer information if tracer was added
            const tracerType = document.querySelector('input[name="tracerType"]:checked');
            if (submissionData.tracerAdded && tracerType) {
                submissionData.typeOfTracer = tracerType.value === 'aware' ? 'Aware' : 'Custom';
                
                if (tracerType.value === 'aware') {
                    const tracerDate = document.getElementById('tracerDate');
                    if (tracerDate) {
                        submissionData.awareTracerPositiveScanDate = tracerDate.value;
                        submissionData.awareTracerConfirmation = true;
                    }
                } else if (tracerType.value === 'custom') {
                    const tracerName = document.getElementById('tracerName');
                    if (tracerName) {
                        submissionData.customTracerName = tracerName.value;
                        submissionData.customTracerConfirmation = true;
                    }
                }
            }

            // Determine validation method
            if (document.getElementById('selfValidationList') && document.getElementById('selfValidationList').children.length > 0) {
                submissionData.validationMethod = 'SelfValidation';
            } else if (document.getElementById('guanXuList') && document.getElementById('guanXuList').children.length > 0) {
                submissionData.validationMethod = 'GuanXu';
            } else if (document.getElementById('stcpList') && document.getElementById('stcpList').children.length > 0) {
                submissionData.validationMethod = 'STCP';
            }

            // Send data to API
            const sdk = new AwareSDK('http://localhost:3000');
            sdk.createSubmission(submissionData)
                .then(response => {
                    document.getElementById('predictedData').style.display = 'none';
                    document.getElementById('successMessage').style.display = 'block';
                    document.getElementById('successMessage').innerHTML = `‚úÖ <strong>Success!</strong> Your tokens have been successfully updated and saved to Excel. ${weight} kg material = ${weight} tokens.<br><small>Submission ID: ${response.submissionId}</small>`;

                    document.getElementById('successMessage').scrollIntoView({ behavior: 'smooth', block: 'center' });

                    setTimeout(() => {
                        document.getElementById('previousBatch').value = '';
                        document.getElementById('changes').value = '';
                        document.getElementById('successMessage').style.display = 'none';
                        // Reset form
                        location.reload();
                    }, 5000);
                })
                .catch(error => {
                    console.error('API Error:', error);
                    let errorMessage = 'Error saving data to API: ' + error.message;
                    
                    // Check if it's a validation error
                    if (error.message.includes('400')) {
                        errorMessage += '\n\n‚ö†Ô∏è Validation Error - Please check:\n';
                        errorMessage += '‚Ä¢ All required fields are filled in\n';
                        errorMessage += '‚Ä¢ Material percentages add up to 100%\n';
                        errorMessage += '‚Ä¢ Batch number is provided\n';
                        errorMessage += '\nCheck the browser console (F12) for more details.';
                    } else if (error.message.includes('fetch')) {
                        errorMessage += '\n\n‚ö†Ô∏è Cannot connect to API server.\n';
                        errorMessage += 'Please make sure the server is running:\n';
                        errorMessage += '1. Open terminal\n';
                        errorMessage += '2. cd aware-platform\n';
                        errorMessage += '3. npm start';
                    }
                    
                    alert(errorMessage);
                });
        }

        // Navigation functions for predicted data sections
        function nextPredictedSection(section) {
            // Hide all sections
            document.querySelectorAll('#predictedData .section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('#predictedData .progress-bar .step').forEach(s => s.classList.remove('active'));

            // Show selected section
            document.getElementById('section' + section).classList.add('active');
            const activeStep = document.querySelector(`#predictedData .progress-bar .step[data-step="${section}"]`);
            if (activeStep) activeStep.classList.add('active');

            // Scroll to top smoothly
            document.getElementById('predictedData').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function prevPredictedSection(section) {
            nextPredictedSection(section);
        }

        // Check authentication on page load
        window.addEventListener('load', async () => {
            await checkAuthentication();
            await loadUpdateBatches();
            
            // Allow clicking on progress steps to navigate
            document.querySelectorAll('#predictedData .progress-bar .step').forEach(step => {
                step.addEventListener('click', function() {
                    const sectionNum = this.getAttribute('data-step');
                    nextPredictedSection(sectionNum);
                });
            });
        });

        async function checkAuthentication() {
            try {
                const response = await fetch('/api/auth/session', {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (!data.loggedIn) {
                    window.location.href = 'login.html';
                    return;
                }

                currentUser = data.user;
                document.getElementById('username-display').textContent = currentUser.username;
                const roles = ['Producer', 'Manufacturer', 'Distributor', 'Certifier', 'Admin'];
                document.getElementById('role-display').textContent = roles[currentUser.role] || 'Unknown';
                
                // Update sidebar navigation
                updateSidebarForRole();
                
                // Only allow Producer and Admin roles to update batches
                if (currentUser.role !== 0 && currentUser.role !== 4) {
                    alert('Access denied. Only producers can update batches.');
                    window.location.href = 'index.html';
                    return;
                }
            } catch (error) {
                console.error('Auth check error:', error);
                window.location.href = 'login.html';
            }
        }
        
        function updateSidebarForRole() {
            const sidebarNav = document.getElementById('sidebar-nav');
            if (!currentUser) return;

            const ROLES = {
                PRODUCER: 0,
                MANUFACTURER: 1,
                DISTRIBUTOR: 2,
                CERTIFIER: 3,
                ADMIN: 4
            };

            let navHtml = '<a href="index.html">Home</a>';

            // Producer can create and update batches
            if (currentUser.role === ROLES.PRODUCER) {
                navHtml += `
                    <a href="create_token.html">Create Token</a>
                    <a href="update_token.html" class="active">Update Token</a>
                    <a href="wallet.html">Wallet</a>
                `;
            }

            // Brand (Distributor) can only view DPP
            if (currentUser.role === ROLES.DISTRIBUTOR) {
                navHtml += '<a href="dpp.html">Digital Product Passport</a>';
            }

            // Admin has all options
            if (currentUser.role === ROLES.ADMIN) {
                navHtml += `
                    <a href="create_token.html">Create Token</a>
                    <a href="update_token.html" class="active">Update Token</a>
                    <a href="batch_approve.html">Approve Batches</a>
                `;
            }

            sidebarNav.innerHTML = navHtml;
        }

        async function logout() {
            try {
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // Override getStatusBadge from batches.js to match approve batches styling
        function getStatusBadge(status) {
            const statusLabels = {
                0: 'Pending',
                1: 'Approved',
                2: 'Rejected',
                3: 'Certified'
            };
            const statusClasses = {
                0: 'status-pending',
                1: 'status-approved',
                2: 'status-rejected',
                3: 'status-certified'
            };
            const label = statusLabels[status] || 'Unknown';
            const className = statusClasses[status] || '';
            return '<span class="status-badge ' + className + '">' + label + '</span>';
        }
    </script>
                    </div>
                </div>
            </section>
        </main>
    </div>
</body>

</html>